/*
 * Copyright 2021 ACINQ SAS
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package fr.acinq.bitcoin.psbt

import fr.acinq.bitcoin.*
import fr.acinq.bitcoin.SigHash.SIGHASH_ALL
import fr.acinq.bitcoin.SigHash.SIGHASH_ANYONECANPAY
import fr.acinq.bitcoin.SigHash.SIGHASH_NONE
import fr.acinq.bitcoin.SigHash.SIGHASH_SINGLE
import fr.acinq.bitcoin.utils.Either
import fr.acinq.bitcoin.utils.flatMap
import fr.acinq.secp256k1.Hex
import kotlin.test.*

class PsbtTestsCommon {

    private val masterPrivKey = DeterministicWallet.ExtendedPrivateKey.decode("tprv8ZgxMBicQKsPd9TeAdPADNnSyH9SSUUbTVeFszDE23Ki6TBB5nCefAdHkK8Fm3qMQR6sHwA56zqRmKmxnHk37JkiFzvncDqoKmPWubu7hDF").second

    @Test
    fun `invalid psbts`() {
        // @formatter:off
        /** OFFICIAL TEST VECTORS */
        // Network transaction, not PSBT format
        assertEquals(
            Either.Left(ParseFailure.InvalidMagicBytes),
            Psbt.read(ByteVector("0200000001268171371edff285e937adeea4b37b78000c0566cbb3ad64641713ca42171bf6000000006a473044022070b2245123e6bf474d60c5b50c043d4c691a5d2435f09a34a7662a9dc251790a022001329ca9dacf280bdf30740ec0390422422c81cb45839457aeb76fc12edd95b3012102657d118d3357b8e0f4c2cd46db7b39f6d9c38d9a70abcb9b2de5dc8dbfe4ce31feffffff02d3dff505000000001976a914d0c59903c5bac2868760e90fd521a4665aa7652088ac00e1f5050000000017a9143545e6e33b832c47050f24d3eeb93c9c03948bc787b32e1300"))
        )
        // PSBT missing outputs
        assertEquals(
            Either.Left(ParseFailure.InvalidContent),
            Psbt.read(
                ByteVector(
                    "70736274ff0100750200000001268171371edff285e937adeea4b37b78000c0566cbb3ad64641713ca42171bf60000000000feffffff02d3dff505000000001976a914d0c59903c5bac2868760e90fd521a4665aa7652088ac00e1f5050000000017a9143545e6e33b832c47050f24d3eeb93c9c03948bc787b32e1300000100fda5010100000000010289a3c71eab4d20e0371bbba4cc698fa295c9463afa2e397f8533ccb62f9567e50100000017160014be18d152a9b012039daf3da7de4f53349eecb985ffffffff86f8aa43a71dff1448893a530a7237ef6b4608bbb2dd2d0171e63aec6a4890b40100000017160014fe3e9ef1a745e974d902c4355943abcb34bd5353ffffffff0200c2eb0b000000001976a91485cff1097fd9e008bb34af709c62197b38978a4888ac72fef84e2c00000017a914339725ba21efd62ac753a9bcd067d6c7a6a39d05870247304402202712be22e0270f394f568311dc7ca9a68970b8025fdd3b240229f07f8a5f3a240220018b38d7dcd314e734c9276bd6fb40f673325bc4baa144c800d2f2f02db2765c012103d2e15674941bad4a996372cb87e1856d3652606d98562fe39c5e9e7e413f210502483045022100d12b852d85dcd961d2f5f4ab660654df6eedcc794c0c33ce5cc309ffb5fce58d022067338a8e0e1725c197fb1a88af59f51e44e4255b20167c8684031c05d1f2592a01210223b72beef0965d10be0778efecd61fcac6f79a4ea169393380734464f84f2ab30000000000"
                )
            )
        )
        // PSBT where one input has a filled scriptSig in the unsigned tx
        assertEquals(
            Either.Left(ParseFailure.InvalidGlobalTx("global tx inputs must have empty scriptSigs and witness")),
            Psbt.read(ByteVector("70736274ff0100fd0a010200000002ab0949a08c5af7c49b8212f417e2f15ab3f5c33dcf153821a8139f877a5b7be4000000006a47304402204759661797c01b036b25928948686218347d89864b719e1f7fcf57d1e511658702205309eabf56aa4d8891ffd111fdf1336f3a29da866d7f8486d75546ceedaf93190121035cdc61fc7ba971c0b501a646a2a83b102cb43881217ca682dc86e2d73fa88292feffffffab0949a08c5af7c49b8212f417e2f15ab3f5c33dcf153821a8139f877a5b7be40100000000feffffff02603bea0b000000001976a914768a40bbd740cbe81d988e71de2a4d5c71396b1d88ac8e240000000000001976a9146f4620b553fa095e721b9ee0efe9fa039cca459788ac00000000000001012000e1f5050000000017a9143545e6e33b832c47050f24d3eeb93c9c03948bc787010416001485d13537f2e265405a34dbafa9e3dda01fb82308000000"))
        )
        // PSBT where inputs and outputs are provided but without an unsigned tx
        assertEquals(
            Either.Left(ParseFailure.GlobalTxMissing),
            Psbt.read(ByteVector("70736274ff000100fda5010100000000010289a3c71eab4d20e0371bbba4cc698fa295c9463afa2e397f8533ccb62f9567e50100000017160014be18d152a9b012039daf3da7de4f53349eecb985ffffffff86f8aa43a71dff1448893a530a7237ef6b4608bbb2dd2d0171e63aec6a4890b40100000017160014fe3e9ef1a745e974d902c4355943abcb34bd5353ffffffff0200c2eb0b000000001976a91485cff1097fd9e008bb34af709c62197b38978a4888ac72fef84e2c00000017a914339725ba21efd62ac753a9bcd067d6c7a6a39d05870247304402202712be22e0270f394f568311dc7ca9a68970b8025fdd3b240229f07f8a5f3a240220018b38d7dcd314e734c9276bd6fb40f673325bc4baa144c800d2f2f02db2765c012103d2e15674941bad4a996372cb87e1856d3652606d98562fe39c5e9e7e413f210502483045022100d12b852d85dcd961d2f5f4ab660654df6eedcc794c0c33ce5cc309ffb5fce58d022067338a8e0e1725c197fb1a88af59f51e44e4255b20167c8684031c05d1f2592a01210223b72beef0965d10be0778efecd61fcac6f79a4ea169393380734464f84f2ab30000000000"))
        )
        // PSBT with duplicate keys in an input
        assertEquals(
            Either.Left(ParseFailure.DuplicateKeys),
            Psbt.read(
                ByteVector(
                    "70736274ff0100750200000001268171371edff285e937adeea4b37b78000c0566cbb3ad64641713ca42171bf60000000000feffffff02d3dff505000000001976a914d0c59903c5bac2868760e90fd521a4665aa7652088ac00e1f5050000000017a9143545e6e33b832c47050f24d3eeb93c9c03948bc787b32e1300000100fda5010100000000010289a3c71eab4d20e0371bbba4cc698fa295c9463afa2e397f8533ccb62f9567e50100000017160014be18d152a9b012039daf3da7de4f53349eecb985ffffffff86f8aa43a71dff1448893a530a7237ef6b4608bbb2dd2d0171e63aec6a4890b40100000017160014fe3e9ef1a745e974d902c4355943abcb34bd5353ffffffff0200c2eb0b000000001976a91485cff1097fd9e008bb34af709c62197b38978a4888ac72fef84e2c00000017a914339725ba21efd62ac753a9bcd067d6c7a6a39d05870247304402202712be22e0270f394f568311dc7ca9a68970b8025fdd3b240229f07f8a5f3a240220018b38d7dcd314e734c9276bd6fb40f673325bc4baa144c800d2f2f02db2765c012103d2e15674941bad4a996372cb87e1856d3652606d98562fe39c5e9e7e413f210502483045022100d12b852d85dcd961d2f5f4ab660654df6eedcc794c0c33ce5cc309ffb5fce58d022067338a8e0e1725c197fb1a88af59f51e44e4255b20167c8684031c05d1f2592a01210223b72beef0965d10be0778efecd61fcac6f79a4ea169393380734464f84f2ab30000000001003f0200000001ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000ffffffff010000000000000000036a010000000000000000"
                )
            )
        )
        // PSBT with invalid global transaction typed key
        assertEquals(
            Either.Left(ParseFailure.InvalidGlobalTx("global tx key must contain exactly 1 byte")),
            Psbt.read(ByteVector("70736274ff020001550200000001279a2323a5dfb51fc45f220fa58b0fc13e1e3342792a85d7e36cd6333b5cbc390000000000ffffffff01a05aea0b000000001976a914ffe9c0061097cc3b636f2cb0460fa4fc427d2b4588ac0000000000010120955eea0b0000000017a9146345200f68d189e1adc0df1c4d16ea8f14c0dbeb87220203b1341ccba7683b6af4f1238cd6e97e7167d569fac47f1e48d47541844355bd4646304302200424b58effaaa694e1559ea5c93bbfd4a89064224055cdf070b6771469442d07021f5c8eb0fea6516d60b8acb33ad64ede60e8785bfb3aa94b99bdf86151db9a9a010104220020771fd18ad459666dd49f3d564e3dbc42f4c84774e360ada16816a8ed488d5681010547522103b1341ccba7683b6af4f1238cd6e97e7167d569fac47f1e48d47541844355bd462103de55d1e1dac805e3f8a58c1fbf9b94c02f3dbaafe127fefca4995f26f82083bd52ae220603b1341ccba7683b6af4f1238cd6e97e7167d569fac47f1e48d47541844355bd4610b4a6ba67000000800000008004000080220603de55d1e1dac805e3f8a58c1fbf9b94c02f3dbaafe127fefca4995f26f82083bd10b4a6ba670000008000000080050000800000"))
        )
        // PSBT with invalid input witness utxo typed key
        assertEquals(
            Either.Left(ParseFailure.InvalidTxInput("witness utxo key must contain exactly 1 byte")),
            Psbt.read(ByteVector("70736274ff0100550200000001279a2323a5dfb51fc45f220fa58b0fc13e1e3342792a85d7e36cd6333b5cbc390000000000ffffffff01a05aea0b000000001976a914ffe9c0061097cc3b636f2cb0460fa4fc427d2b4588ac000000000002010020955eea0b0000000017a9146345200f68d189e1adc0df1c4d16ea8f14c0dbeb87220203b1341ccba7683b6af4f1238cd6e97e7167d569fac47f1e48d47541844355bd4646304302200424b58effaaa694e1559ea5c93bbfd4a89064224055cdf070b6771469442d07021f5c8eb0fea6516d60b8acb33ad64ede60e8785bfb3aa94b99bdf86151db9a9a010104220020771fd18ad459666dd49f3d564e3dbc42f4c84774e360ada16816a8ed488d5681010547522103b1341ccba7683b6af4f1238cd6e97e7167d569fac47f1e48d47541844355bd462103de55d1e1dac805e3f8a58c1fbf9b94c02f3dbaafe127fefca4995f26f82083bd52ae220603b1341ccba7683b6af4f1238cd6e97e7167d569fac47f1e48d47541844355bd4610b4a6ba67000000800000008004000080220603de55d1e1dac805e3f8a58c1fbf9b94c02f3dbaafe127fefca4995f26f82083bd10b4a6ba670000008000000080050000800000"))
        )
        // PSBT with invalid pubkey length for input partial signature typed key
        assertEquals(
            Either.Left(ParseFailure.InvalidTxInput("public key must contain exactly 33 bytes")),
            Psbt.read(ByteVector("70736274ff0100550200000001279a2323a5dfb51fc45f220fa58b0fc13e1e3342792a85d7e36cd6333b5cbc390000000000ffffffff01a05aea0b000000001976a914ffe9c0061097cc3b636f2cb0460fa4fc427d2b4588ac0000000000010120955eea0b0000000017a9146345200f68d189e1adc0df1c4d16ea8f14c0dbeb87210203b1341ccba7683b6af4f1238cd6e97e7167d569fac47f1e48d47541844355bd46304302200424b58effaaa694e1559ea5c93bbfd4a89064224055cdf070b6771469442d07021f5c8eb0fea6516d60b8acb33ad64ede60e8785bfb3aa94b99bdf86151db9a9a010104220020771fd18ad459666dd49f3d564e3dbc42f4c84774e360ada16816a8ed488d5681010547522103b1341ccba7683b6af4f1238cd6e97e7167d569fac47f1e48d47541844355bd462103de55d1e1dac805e3f8a58c1fbf9b94c02f3dbaafe127fefca4995f26f82083bd52ae220603b1341ccba7683b6af4f1238cd6e97e7167d569fac47f1e48d47541844355bd4610b4a6ba67000000800000008004000080220603de55d1e1dac805e3f8a58c1fbf9b94c02f3dbaafe127fefca4995f26f82083bd10b4a6ba670000008000000080050000800000"))
        )
        // PSBT with invalid redeemScript typed key
        assertEquals(
            Either.Left(ParseFailure.InvalidTxInput("redeem script key must contain exactly 1 byte")),
            Psbt.read(ByteVector("70736274ff0100550200000001279a2323a5dfb51fc45f220fa58b0fc13e1e3342792a85d7e36cd6333b5cbc390000000000ffffffff01a05aea0b000000001976a914ffe9c0061097cc3b636f2cb0460fa4fc427d2b4588ac0000000000010120955eea0b0000000017a9146345200f68d189e1adc0df1c4d16ea8f14c0dbeb87220203b1341ccba7683b6af4f1238cd6e97e7167d569fac47f1e48d47541844355bd4646304302200424b58effaaa694e1559ea5c93bbfd4a89064224055cdf070b6771469442d07021f5c8eb0fea6516d60b8acb33ad64ede60e8785bfb3aa94b99bdf86151db9a9a01020400220020771fd18ad459666dd49f3d564e3dbc42f4c84774e360ada16816a8ed488d5681010547522103b1341ccba7683b6af4f1238cd6e97e7167d569fac47f1e48d47541844355bd462103de55d1e1dac805e3f8a58c1fbf9b94c02f3dbaafe127fefca4995f26f82083bd52ae220603b1341ccba7683b6af4f1238cd6e97e7167d569fac47f1e48d47541844355bd4610b4a6ba67000000800000008004000080220603de55d1e1dac805e3f8a58c1fbf9b94c02f3dbaafe127fefca4995f26f82083bd10b4a6ba670000008000000080050000800000"))
        )
        // PSBT with invalid witnessScript typed key
        assertEquals(
            Either.Left(ParseFailure.InvalidTxInput("witness script key must contain exactly 1 byte")),
            Psbt.read(ByteVector("70736274ff0100550200000001279a2323a5dfb51fc45f220fa58b0fc13e1e3342792a85d7e36cd6333b5cbc390000000000ffffffff01a05aea0b000000001976a914ffe9c0061097cc3b636f2cb0460fa4fc427d2b4588ac0000000000010120955eea0b0000000017a9146345200f68d189e1adc0df1c4d16ea8f14c0dbeb87220203b1341ccba7683b6af4f1238cd6e97e7167d569fac47f1e48d47541844355bd4646304302200424b58effaaa694e1559ea5c93bbfd4a89064224055cdf070b6771469442d07021f5c8eb0fea6516d60b8acb33ad64ede60e8785bfb3aa94b99bdf86151db9a9a010104220020771fd18ad459666dd49f3d564e3dbc42f4c84774e360ada16816a8ed488d568102050047522103b1341ccba7683b6af4f1238cd6e97e7167d569fac47f1e48d47541844355bd462103de55d1e1dac805e3f8a58c1fbf9b94c02f3dbaafe127fefca4995f26f82083bd52ae220603b1341ccba7683b6af4f1238cd6e97e7167d569fac47f1e48d47541844355bd4610b4a6ba67000000800000008004000080220603de55d1e1dac805e3f8a58c1fbf9b94c02f3dbaafe127fefca4995f26f82083bd10b4a6ba670000008000000080050000800000"))
        )
        // PSBT with invalid bip32 typed key
        assertEquals(
            Either.Left(ParseFailure.InvalidTxInput("bip32 derivation public key must contain exactly 33 bytes")),
            Psbt.read(ByteVector("70736274ff0100550200000001279a2323a5dfb51fc45f220fa58b0fc13e1e3342792a85d7e36cd6333b5cbc390000000000ffffffff01a05aea0b000000001976a914ffe9c0061097cc3b636f2cb0460fa4fc427d2b4588ac0000000000010120955eea0b0000000017a9146345200f68d189e1adc0df1c4d16ea8f14c0dbeb87220203b1341ccba7683b6af4f1238cd6e97e7167d569fac47f1e48d47541844355bd4646304302200424b58effaaa694e1559ea5c93bbfd4a89064224055cdf070b6771469442d07021f5c8eb0fea6516d60b8acb33ad64ede60e8785bfb3aa94b99bdf86151db9a9a010104220020771fd18ad459666dd49f3d564e3dbc42f4c84774e360ada16816a8ed488d5681010547522103b1341ccba7683b6af4f1238cd6e97e7167d569fac47f1e48d47541844355bd462103de55d1e1dac805e3f8a58c1fbf9b94c02f3dbaafe127fefca4995f26f82083bd52ae210603b1341ccba7683b6af4f1238cd6e97e7167d569fac47f1e48d47541844355bd10b4a6ba67000000800000008004000080220603de55d1e1dac805e3f8a58c1fbf9b94c02f3dbaafe127fefca4995f26f82083bd10b4a6ba670000008000000080050000800000"))
        )
        // PSBT with invalid non-witness utxo typed key
        assertEquals(
            Either.Left(ParseFailure.InvalidTxInput("non-witness utxo key must contain exactly 1 byte")),
            Psbt.read(
                ByteVector(
                    "70736274ff01009a020000000258e87a21b56daf0c23be8e7070456c336f7cbaa5c8757924f545887bb2abdd750000000000ffffffff838d0427d0ec650a68aa46bb0b098aea4422c071b2ca78352a077959d07cea1d0100000000ffffffff0270aaf00800000000160014d85c2b71d0060b09c9886aeb815e50991dda124d00e1f5050000000016001400aea9a2e5f0f876a588df5546e8742d1d87008f0000000000020000bb0200000001aad73931018bd25f84ae400b68848be09db706eac2ac18298babee71ab656f8b0000000048473044022058f6fc7c6a33e1b31548d481c826c015bd30135aad42cd67790dab66d2ad243b02204a1ced2604c6735b6393e5b41691dd78b00f0c5942fb9f751856faa938157dba01feffffff0280f0fa020000000017a9140fb9463421696b82c833af241c78c17ddbde493487d0f20a270100000017a91429ca74f8a08f81999428185c97b5d852e4063f6187650000000107da00473044022074018ad4180097b873323c0015720b3684cc8123891048e7dbcd9b55ad679c99022073d369b740e3eb53dcefa33823c8070514ca55a7dd9544f157c167913261118c01483045022100f61038b308dc1da865a34852746f015772934208c6d24454393cd99bdf2217770220056e675a675a6d0a02b85b14e5e29074d8a25a9b5760bea2816f661910a006ea01475221029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f2102dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d752ae0001012000c2eb0b0000000017a914b7f5faf40e3d40a5a459b1db3535f2b72fa921e8870107232200208c2353173743b595dfb4a07b72ba8e42e3797da74e87fe7d9d7497e3b20289030108da0400473044022062eb7a556107a7c73f45ac4ab5a1dddf6f7075fb1275969a7f383efff784bcb202200c05dbb7470dbf2f08557dd356c7325c1ed30913e996cd3840945db12228da5f01473044022065f45ba5998b59a27ffe1a7bed016af1f1f90d54b3aa8f7450aa5f56a25103bd02207f724703ad1edb96680b284b56d4ffcb88f7fb759eabbe08aa30f29b851383d20147522103089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc21023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7352ae00220203a9a4c37f5996d3aa25dbac6b570af0650394492942460b354753ed9eeca5877110d90c6a4f000000800000008004000080002202027f6399757d2eff55a136ad02c684b1838b6556e5f1b6b34282a94b6b5005109610d90c6a4f00000080000000800500008000"
                )
            )
        )
        // PSBT with invalid final scriptsig typed key
        assertEquals(
            Either.Left(ParseFailure.InvalidTxInput("script sig key must contain exactly 1 byte")),
            Psbt.read(
                ByteVector(
                    "70736274ff01009a020000000258e87a21b56daf0c23be8e7070456c336f7cbaa5c8757924f545887bb2abdd750000000000ffffffff838d0427d0ec650a68aa46bb0b098aea4422c071b2ca78352a077959d07cea1d0100000000ffffffff0270aaf00800000000160014d85c2b71d0060b09c9886aeb815e50991dda124d00e1f5050000000016001400aea9a2e5f0f876a588df5546e8742d1d87008f00000000000100bb0200000001aad73931018bd25f84ae400b68848be09db706eac2ac18298babee71ab656f8b0000000048473044022058f6fc7c6a33e1b31548d481c826c015bd30135aad42cd67790dab66d2ad243b02204a1ced2604c6735b6393e5b41691dd78b00f0c5942fb9f751856faa938157dba01feffffff0280f0fa020000000017a9140fb9463421696b82c833af241c78c17ddbde493487d0f20a270100000017a91429ca74f8a08f81999428185c97b5d852e4063f618765000000020700da00473044022074018ad4180097b873323c0015720b3684cc8123891048e7dbcd9b55ad679c99022073d369b740e3eb53dcefa33823c8070514ca55a7dd9544f157c167913261118c01483045022100f61038b308dc1da865a34852746f015772934208c6d24454393cd99bdf2217770220056e675a675a6d0a02b85b14e5e29074d8a25a9b5760bea2816f661910a006ea01475221029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f2102dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d752ae0001012000c2eb0b0000000017a914b7f5faf40e3d40a5a459b1db3535f2b72fa921e8870107232200208c2353173743b595dfb4a07b72ba8e42e3797da74e87fe7d9d7497e3b20289030108da0400473044022062eb7a556107a7c73f45ac4ab5a1dddf6f7075fb1275969a7f383efff784bcb202200c05dbb7470dbf2f08557dd356c7325c1ed30913e996cd3840945db12228da5f01473044022065f45ba5998b59a27ffe1a7bed016af1f1f90d54b3aa8f7450aa5f56a25103bd02207f724703ad1edb96680b284b56d4ffcb88f7fb759eabbe08aa30f29b851383d20147522103089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc21023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7352ae00220203a9a4c37f5996d3aa25dbac6b570af0650394492942460b354753ed9eeca5877110d90c6a4f000000800000008004000080002202027f6399757d2eff55a136ad02c684b1838b6556e5f1b6b34282a94b6b5005109610d90c6a4f00000080000000800500008000"
                )
            )
        )
        // PSBT with invalid final script witness typed key
        assertEquals(
            Either.Left(ParseFailure.InvalidTxInput("script witness key must contain exactly 1 byte")),
            Psbt.read(
                ByteVector(
                    "70736274ff01009a020000000258e87a21b56daf0c23be8e7070456c336f7cbaa5c8757924f545887bb2abdd750000000000ffffffff838d0427d0ec650a68aa46bb0b098aea4422c071b2ca78352a077959d07cea1d0100000000ffffffff0270aaf00800000000160014d85c2b71d0060b09c9886aeb815e50991dda124d00e1f5050000000016001400aea9a2e5f0f876a588df5546e8742d1d87008f00000000000100bb0200000001aad73931018bd25f84ae400b68848be09db706eac2ac18298babee71ab656f8b0000000048473044022058f6fc7c6a33e1b31548d481c826c015bd30135aad42cd67790dab66d2ad243b02204a1ced2604c6735b6393e5b41691dd78b00f0c5942fb9f751856faa938157dba01feffffff0280f0fa020000000017a9140fb9463421696b82c833af241c78c17ddbde493487d0f20a270100000017a91429ca74f8a08f81999428185c97b5d852e4063f6187650000000107da00473044022074018ad4180097b873323c0015720b3684cc8123891048e7dbcd9b55ad679c99022073d369b740e3eb53dcefa33823c8070514ca55a7dd9544f157c167913261118c01483045022100f61038b308dc1da865a34852746f015772934208c6d24454393cd99bdf2217770220056e675a675a6d0a02b85b14e5e29074d8a25a9b5760bea2816f661910a006ea01475221029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f2102dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d752ae0001012000c2eb0b0000000017a914b7f5faf40e3d40a5a459b1db3535f2b72fa921e8870107232200208c2353173743b595dfb4a07b72ba8e42e3797da74e87fe7d9d7497e3b2028903020800da0400473044022062eb7a556107a7c73f45ac4ab5a1dddf6f7075fb1275969a7f383efff784bcb202200c05dbb7470dbf2f08557dd356c7325c1ed30913e996cd3840945db12228da5f01473044022065f45ba5998b59a27ffe1a7bed016af1f1f90d54b3aa8f7450aa5f56a25103bd02207f724703ad1edb96680b284b56d4ffcb88f7fb759eabbe08aa30f29b851383d20147522103089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc21023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7352ae00220203a9a4c37f5996d3aa25dbac6b570af0650394492942460b354753ed9eeca5877110d90c6a4f000000800000008004000080002202027f6399757d2eff55a136ad02c684b1838b6556e5f1b6b34282a94b6b5005109610d90c6a4f00000080000000800500008000"
                )
            )
        )
        // PSBT with invalid pubkey in output BIP 32 derivation paths typed key
        assertEquals(
            Either.Left(ParseFailure.InvalidTxOutput("bip32 derivation public key must contain exactly 33 bytes")),
            Psbt.read(
                ByteVector(
                    "70736274ff01009a020000000258e87a21b56daf0c23be8e7070456c336f7cbaa5c8757924f545887bb2abdd750000000000ffffffff838d0427d0ec650a68aa46bb0b098aea4422c071b2ca78352a077959d07cea1d0100000000ffffffff0270aaf00800000000160014d85c2b71d0060b09c9886aeb815e50991dda124d00e1f5050000000016001400aea9a2e5f0f876a588df5546e8742d1d87008f00000000000100bb0200000001aad73931018bd25f84ae400b68848be09db706eac2ac18298babee71ab656f8b0000000048473044022058f6fc7c6a33e1b31548d481c826c015bd30135aad42cd67790dab66d2ad243b02204a1ced2604c6735b6393e5b41691dd78b00f0c5942fb9f751856faa938157dba01feffffff0280f0fa020000000017a9140fb9463421696b82c833af241c78c17ddbde493487d0f20a270100000017a91429ca74f8a08f81999428185c97b5d852e4063f6187650000000107da00473044022074018ad4180097b873323c0015720b3684cc8123891048e7dbcd9b55ad679c99022073d369b740e3eb53dcefa33823c8070514ca55a7dd9544f157c167913261118c01483045022100f61038b308dc1da865a34852746f015772934208c6d24454393cd99bdf2217770220056e675a675a6d0a02b85b14e5e29074d8a25a9b5760bea2816f661910a006ea01475221029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f2102dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d752ae0001012000c2eb0b0000000017a914b7f5faf40e3d40a5a459b1db3535f2b72fa921e8870107232200208c2353173743b595dfb4a07b72ba8e42e3797da74e87fe7d9d7497e3b20289030108da0400473044022062eb7a556107a7c73f45ac4ab5a1dddf6f7075fb1275969a7f383efff784bcb202200c05dbb7470dbf2f08557dd356c7325c1ed30913e996cd3840945db12228da5f01473044022065f45ba5998b59a27ffe1a7bed016af1f1f90d54b3aa8f7450aa5f56a25103bd02207f724703ad1edb96680b284b56d4ffcb88f7fb759eabbe08aa30f29b851383d20147522103089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc21023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7352ae00210203a9a4c37f5996d3aa25dbac6b570af0650394492942460b354753ed9eeca58710d90c6a4f000000800000008004000080002202027f6399757d2eff55a136ad02c684b1838b6556e5f1b6b34282a94b6b5005109610d90c6a4f00000080000000800500008000"
                )
            )
        )
        // PSBT with invalid input sighash type typed key
        assertEquals(
            Either.Left(ParseFailure.InvalidTxInput("sighash type key must contain exactly 1 byte")),
            Psbt.read(ByteVector("70736274ff0100730200000001301ae986e516a1ec8ac5b4bc6573d32f83b465e23ad76167d68b38e730b4dbdb0000000000ffffffff02747b01000000000017a91403aa17ae882b5d0d54b25d63104e4ffece7b9ea2876043993b0000000017a914b921b1ba6f722e4bfa83b6557a3139986a42ec8387000000000001011f00ca9a3b00000000160014d2d94b64ae08587eefc8eeb187c601e939f9037c0203000100000000010016001462e9e982fff34dd8239610316b090cd2a3b747cb000100220020876bad832f1d168015ed41232a9ea65a1815d9ef13c0ef8759f64b5b2b278a65010125512103b7ce23a01c5b4bf00a642537cdfabb315b668332867478ef51309d2bd57f8a8751ae00"))
        )
        // PSBT with invalid output redeemScript typed key
        assertEquals(
            Either.Left(ParseFailure.InvalidTxOutput("redeem script key must contain exactly 1 byte")),
            Psbt.read(ByteVector("70736274ff0100730200000001301ae986e516a1ec8ac5b4bc6573d32f83b465e23ad76167d68b38e730b4dbdb0000000000ffffffff02747b01000000000017a91403aa17ae882b5d0d54b25d63104e4ffece7b9ea2876043993b0000000017a914b921b1ba6f722e4bfa83b6557a3139986a42ec8387000000000001011f00ca9a3b00000000160014d2d94b64ae08587eefc8eeb187c601e939f9037c0002000016001462e9e982fff34dd8239610316b090cd2a3b747cb000100220020876bad832f1d168015ed41232a9ea65a1815d9ef13c0ef8759f64b5b2b278a65010125512103b7ce23a01c5b4bf00a642537cdfabb315b668332867478ef51309d2bd57f8a8751ae00"))
        )
        // PSBT with invalid output witnessScript typed key
        assertEquals(
            Either.Left(ParseFailure.InvalidTxOutput("witness script key must contain exactly 1 byte")),
            Psbt.read(ByteVector("70736274ff0100730200000001301ae986e516a1ec8ac5b4bc6573d32f83b465e23ad76167d68b38e730b4dbdb0000000000ffffffff02747b01000000000017a91403aa17ae882b5d0d54b25d63104e4ffece7b9ea2876043993b0000000017a914b921b1ba6f722e4bfa83b6557a3139986a42ec8387000000000001011f00ca9a3b00000000160014d2d94b64ae08587eefc8eeb187c601e939f9037c00010016001462e9e982fff34dd8239610316b090cd2a3b747cb000100220020876bad832f1d168015ed41232a9ea65a1815d9ef13c0ef8759f64b5b2b278a6521010025512103b7ce23a01c5b4bf00a642537cdfabb315b668332867478ef51309d06d57f8a8751ae00"))
        )
        // PSBT with unsigned tx serialized with witness serialization format
        assertEquals(
            Either.Left(ParseFailure.InvalidGlobalTx("cannot read 133 bytes from a stream that has 105 bytes left")),
            Psbt.read(
                ByteVector(
                    "70736274ff01007802000000000101268171371edff285e937adeea4b37b78000c0566cbb3ad64641713ca42171bf60000000000feffffff02d3dff505000000001976a914d0c59903c5bac2868760e90fd521a4665aa7652088ac00e1f5050000000017a9143545e6e33b832c47050f24d3eeb93c9c03948bc78700b32e1300000100fda5010100000000010289a3c71eab4d20e0371bbba4cc698fa295c9463afa2e397f8533ccb62f9567e50100000017160014be18d152a9b012039daf3da7de4f53349eecb985ffffffff86f8aa43a71dff1448893a530a7237ef6b4608bbb2dd2d0171e63aec6a4890b40100000017160014fe3e9ef1a745e974d902c4355943abcb34bd5353ffffffff0200c2eb0b000000001976a91485cff1097fd9e008bb34af709c62197b38978a4888ac72fef84e2c00000017a914339725ba21efd62ac753a9bcd067d6c7a6a39d05870247304402202712be22e0270f394f568311dc7ca9a68970b8025fdd3b240229f07f8a5f3a240220018b38d7dcd314e734c9276bd6fb40f673325bc4baa144c800d2f2f02db2765c012103d2e15674941bad4a996372cb87e1856d3652606d98562fe39c5e9e7e413f210502483045022100d12b852d85dcd961d2f5f4ab660654df6eedcc794c0c33ce5cc309ffb5fce58d022067338a8e0e1725c197fb1a88af59f51e44e4255b20167c8684031c05d1f2592a01210223b72beef0965d10be0778efecd61fcac6f79a4ea169393380734464f84f2ab300000000000000"
                )
            )
        )
        /** ADDITIONAL TEST VECTORS */
        // PSBT missing inputs
        assertEquals(
            Either.Left(ParseFailure.InvalidContent),
            Psbt.read(ByteVector("70736274ff0100750200000001268171371edff285e937adeea4b37b78000c0566cbb3ad64641713ca42171bf60000000000feffffff02d3dff505000000001976a914d0c59903c5bac2868760e90fd521a4665aa7652088ac00e1f5050000000017a9143545e6e33b832c47050f24d3eeb93c9c03948bc787b32e1300000000"))
        )
        // PSBT missing outputs
        assertEquals(
            Either.Left(ParseFailure.InvalidContent),
            Psbt.read(
                ByteVector(
                    "70736274ff0100750200000001268171371edff285e937adeea4b37b78000c0566cbb3ad64641713ca42171bf60000000000feffffff02d3dff505000000001976a914d0c59903c5bac2868760e90fd521a4665aa7652088ac00e1f5050000000017a9143545e6e33b832c47050f24d3eeb93c9c03948bc787b32e1300000100fda5010100000000010289a3c71eab4d20e0371bbba4cc698fa295c9463afa2e397f8533ccb62f9567e50100000017160014be18d152a9b012039daf3da7de4f53349eecb985ffffffff86f8aa43a71dff1448893a530a7237ef6b4608bbb2dd2d0171e63aec6a4890b40100000017160014fe3e9ef1a745e974d902c4355943abcb34bd5353ffffffff0200c2eb0b000000001976a91485cff1097fd9e008bb34af709c62197b38978a4888ac72fef84e2c00000017a914339725ba21efd62ac753a9bcd067d6c7a6a39d05870247304402202712be22e0270f394f568311dc7ca9a68970b8025fdd3b240229f07f8a5f3a240220018b38d7dcd314e734c9276bd6fb40f673325bc4baa144c800d2f2f02db2765c012103d2e15674941bad4a996372cb87e1856d3652606d98562fe39c5e9e7e413f210502483045022100d12b852d85dcd961d2f5f4ab660654df6eedcc794c0c33ce5cc309ffb5fce58d022067338a8e0e1725c197fb1a88af59f51e44e4255b20167c8684031c05d1f2592a01210223b72beef0965d10be0778efecd61fcac6f79a4ea169393380734464f84f2ab3000000000000"
                )
            )
        )
        // @formatter:on
    }

    @Test
    fun `invalids psbts -- non-witness input utxos don't match tx`() {
        val inputTx1 = Transaction(
            version = 2,
            txIn = listOf(TxIn(OutPoint(TxHash("75ddabb27b8845f5247975c8a5ba7c6f336c4570708ebe230caf6db5217ae858"), 1), ByteVector("00208c2353173743b595dfb4a07b72ba8e42e3797da74e87fe7d9d7497e3b2028903"), 0)),
            txOut = listOf(
                TxOut(500.toSatoshi(), ByteVector("0014d85c2b71d0060b09c9886aeb815e50991dda124d")),
                TxOut(750.toSatoshi(), ByteVector("0014d85c2b71d0060b09c9886aeb815e50991dda124d"))
            ),
            lockTime = 0
        )
        val inputTx2 = Transaction(
            version = 2,
            txIn = listOf(TxIn(OutPoint(TxHash("1dea7cd05979072a3578cab271c02244ea8a090bbb46aa680a65ecd027048d83"), 0), ByteVector("00208c2353173743b595dfb4a07b72ba8e42e3797da74e87fe7d9d7497e3b2028903"), 0)),
            txOut = listOf(
                TxOut(800.toSatoshi(), ByteVector("0014d85c2b71d0060b09c9886aeb815e50991dda124d")),
                TxOut(600.toSatoshi(), ByteVector("0014d85c2b71d0060b09c9886aeb815e50991dda124d"))
            ),
            lockTime = 0
        )
        val tx = Transaction(
            version = 2,
            txIn = listOf(
                TxIn(OutPoint(inputTx1, 1), listOf(), 0),
                TxIn(OutPoint(inputTx2, 0), listOf(), 6)
            ),
            txOut = listOf(
                TxOut(300.toSatoshi(), ByteVector("0014d85c2b71d0060b09c9886aeb815e50991dda124d")),
                TxOut(1000.toSatoshi(), ByteVector("0014d85c2b71d0060b09c9886aeb815e50991dda124d"))
            ),
            lockTime = 3
        )
        val psbt = Psbt(tx)
        val updated = psbt.updateNonWitnessInput(inputTx1, 1, redeemScript = listOf(OP_RETURN)).flatMap { it.updateNonWitnessInput(inputTx2, 0, redeemScript = listOf(OP_RETURN)) }
        assertTrue(updated.isRight)

        val outputIndexMismatch = updated.right!!.copy(
            global = updated.right!!.global.copy(
                tx = Transaction(
                    version = 2,
                    txIn = listOf(TxIn(OutPoint(inputTx1, 3), listOf(), 0), TxIn(OutPoint(inputTx2, 0), listOf(), 6)),
                    txOut = listOf(TxOut(300.toSatoshi(), listOf()), TxOut(1000.toSatoshi(), listOf())),
                    lockTime = 3
                )
            )
        )
        assertEquals(Psbt.read(Psbt.write(outputIndexMismatch)), Either.Left(ParseFailure.InvalidTxInput("non-witness utxo does not match psbt outpoint")))

        val txIdMismatch = updated.right!!.copy(
            global = updated.right!!.global.copy(
                tx = Transaction(
                    version = 2,
                    txIn = listOf(TxIn(OutPoint(inputTx2, 1), listOf(), 0), TxIn(OutPoint(inputTx2, 0), listOf(), 6)),
                    txOut = listOf(TxOut(300.toSatoshi(), listOf()), TxOut(1000.toSatoshi(), listOf())),
                    lockTime = 3
                )
            )
        )
        assertEquals(Psbt.read(Psbt.write(txIdMismatch)), Either.Left(ParseFailure.InvalidTxInput("non-witness utxo does not match psbt outpoint")))
    }

    @Test
    fun `valid psbts -- official test vectors`() {
        run {
            // PSBT with one P2PKH input. Outputs are empty
            val bin = ByteVector(
                "70736274ff0100750200000001268171371edff285e937adeea4b37b78000c0566cbb3ad64641713ca42171bf60000000000feffffff02d3dff505000000001976a914d0c59903c5bac2868760e90fd521a4665aa7652088ac00e1f5050000000017a9143545e6e33b832c47050f24d3eeb93c9c03948bc787b32e1300000100fda5010100000000010289a3c71eab4d20e0371bbba4cc698fa295c9463afa2e397f8533ccb62f9567e50100000017160014be18d152a9b012039daf3da7de4f53349eecb985ffffffff86f8aa43a71dff1448893a530a7237ef6b4608bbb2dd2d0171e63aec6a4890b40100000017160014fe3e9ef1a745e974d902c4355943abcb34bd5353ffffffff0200c2eb0b000000001976a91485cff1097fd9e008bb34af709c62197b38978a4888ac72fef84e2c00000017a914339725ba21efd62ac753a9bcd067d6c7a6a39d05870247304402202712be22e0270f394f568311dc7ca9a68970b8025fdd3b240229f07f8a5f3a240220018b38d7dcd314e734c9276bd6fb40f673325bc4baa144c800d2f2f02db2765c012103d2e15674941bad4a996372cb87e1856d3652606d98562fe39c5e9e7e413f210502483045022100d12b852d85dcd961d2f5f4ab660654df6eedcc794c0c33ce5cc309ffb5fce58d022067338a8e0e1725c197fb1a88af59f51e44e4255b20167c8684031c05d1f2592a01210223b72beef0965d10be0778efecd61fcac6f79a4ea169393380734464f84f2ab300000000000000"
            )
            val result = Psbt.read(bin)
            assertTrue(result.isRight)
            val psbt = result.right!!
            verifyNoUnknown(psbt)
            assertEquals(psbt.global.version, 0)
            assertTrue(psbt.global.extendedPublicKeys.isEmpty())
            assertEquals(psbt.global.tx.txIn.size, 1)
            val nonWitnessUtxo = psbt.inputs[0].nonWitnessUtxo
            assertNotNull(nonWitnessUtxo)
            assertEquals(nonWitnessUtxo.version, 1)
            assertEquals(nonWitnessUtxo.txid, psbt.global.tx.txIn[0].outPoint.txid)
            assertEquals(psbt.global.tx.txOut.size, 2)
            psbt.outputs.forEach { verifyEmptyOutput(it) }
            assertEquals(Psbt.write(psbt), bin)
        }
        run {
            // PSBT with one P2PKH input and one P2SH-P2WPKH input. First input is signed and finalized. Outputs are empty
            val bin = ByteVector(
                "70736274ff0100a00200000002ab0949a08c5af7c49b8212f417e2f15ab3f5c33dcf153821a8139f877a5b7be40000000000feffffffab0949a08c5af7c49b8212f417e2f15ab3f5c33dcf153821a8139f877a5b7be40100000000feffffff02603bea0b000000001976a914768a40bbd740cbe81d988e71de2a4d5c71396b1d88ac8e240000000000001976a9146f4620b553fa095e721b9ee0efe9fa039cca459788ac000000000001076a47304402204759661797c01b036b25928948686218347d89864b719e1f7fcf57d1e511658702205309eabf56aa4d8891ffd111fdf1336f3a29da866d7f8486d75546ceedaf93190121035cdc61fc7ba971c0b501a646a2a83b102cb43881217ca682dc86e2d73fa882920001012000e1f5050000000017a9143545e6e33b832c47050f24d3eeb93c9c03948bc787010416001485d13537f2e265405a34dbafa9e3dda01fb82308000000"
            )
            val result = Psbt.read(bin)
            assertTrue(result.isRight)
            val psbt = result.right!!
            verifyNoUnknown(psbt)
            assertEquals(psbt.global.version, 0)
            assertTrue(psbt.global.extendedPublicKeys.isEmpty())
            assertEquals(psbt.global.tx.txIn.size, 2)
            assertNotNull(psbt.inputs[0].scriptSig)
            assertNotNull(psbt.inputs[1].witnessUtxo)
            assertNull(psbt.inputs[1].nonWitnessUtxo)
            assertNotNull(psbt.inputs[1].redeemScript)
            assertEquals(psbt.global.tx.txOut.size, 2)
            psbt.outputs.forEach { verifyEmptyOutput(it) }
            assertEquals(Psbt.write(psbt), bin)
        }
        run {
            // PSBT with one P2PKH input which has a non-final scriptSig and has a sighash type specified. Outputs are empty
            val bin = ByteVector(
                "70736274ff0100750200000001268171371edff285e937adeea4b37b78000c0566cbb3ad64641713ca42171bf60000000000feffffff02d3dff505000000001976a914d0c59903c5bac2868760e90fd521a4665aa7652088ac00e1f5050000000017a9143545e6e33b832c47050f24d3eeb93c9c03948bc787b32e1300000100fda5010100000000010289a3c71eab4d20e0371bbba4cc698fa295c9463afa2e397f8533ccb62f9567e50100000017160014be18d152a9b012039daf3da7de4f53349eecb985ffffffff86f8aa43a71dff1448893a530a7237ef6b4608bbb2dd2d0171e63aec6a4890b40100000017160014fe3e9ef1a745e974d902c4355943abcb34bd5353ffffffff0200c2eb0b000000001976a91485cff1097fd9e008bb34af709c62197b38978a4888ac72fef84e2c00000017a914339725ba21efd62ac753a9bcd067d6c7a6a39d05870247304402202712be22e0270f394f568311dc7ca9a68970b8025fdd3b240229f07f8a5f3a240220018b38d7dcd314e734c9276bd6fb40f673325bc4baa144c800d2f2f02db2765c012103d2e15674941bad4a996372cb87e1856d3652606d98562fe39c5e9e7e413f210502483045022100d12b852d85dcd961d2f5f4ab660654df6eedcc794c0c33ce5cc309ffb5fce58d022067338a8e0e1725c197fb1a88af59f51e44e4255b20167c8684031c05d1f2592a01210223b72beef0965d10be0778efecd61fcac6f79a4ea169393380734464f84f2ab30000000001030401000000000000"
            )
            val result = Psbt.read(bin)
            assertTrue(result.isRight)
            val psbt = result.right!!
            verifyNoUnknown(psbt)
            assertEquals(psbt.inputs.size, 1)
            assertNotNull(psbt.inputs[0].nonWitnessUtxo)
            assertEquals(psbt.inputs[0].sighashType, SIGHASH_ALL)
            psbt.outputs.forEach { verifyEmptyOutput(it) }
            assertEquals(Psbt.write(psbt), bin)
        }
        run {
            // PSBT with one P2PKH input and one P2SH-P2WPKH input both with non-final scriptSigs. P2SH-P2WPKH input's redeemScript is available. Outputs filled.
            val bin = ByteVector(
                "70736274ff0100a00200000002ab0949a08c5af7c49b8212f417e2f15ab3f5c33dcf153821a8139f877a5b7be40000000000feffffffab0949a08c5af7c49b8212f417e2f15ab3f5c33dcf153821a8139f877a5b7be40100000000feffffff02603bea0b000000001976a914768a40bbd740cbe81d988e71de2a4d5c71396b1d88ac8e240000000000001976a9146f4620b553fa095e721b9ee0efe9fa039cca459788ac00000000000100df0200000001268171371edff285e937adeea4b37b78000c0566cbb3ad64641713ca42171bf6000000006a473044022070b2245123e6bf474d60c5b50c043d4c691a5d2435f09a34a7662a9dc251790a022001329ca9dacf280bdf30740ec0390422422c81cb45839457aeb76fc12edd95b3012102657d118d3357b8e0f4c2cd46db7b39f6d9c38d9a70abcb9b2de5dc8dbfe4ce31feffffff02d3dff505000000001976a914d0c59903c5bac2868760e90fd521a4665aa7652088ac00e1f5050000000017a9143545e6e33b832c47050f24d3eeb93c9c03948bc787b32e13000001012000e1f5050000000017a9143545e6e33b832c47050f24d3eeb93c9c03948bc787010416001485d13537f2e265405a34dbafa9e3dda01fb8230800220202ead596687ca806043edc3de116cdf29d5e9257c196cd055cf698c8d02bf24e9910b4a6ba670000008000000080020000800022020394f62be9df19952c5587768aeb7698061ad2c4a25c894f47d8c162b4d7213d0510b4a6ba6700000080010000800200008000"
            )
            val result = Psbt.read(bin)
            assertTrue(result.isRight)
            val psbt = result.right!!
            verifyNoUnknown(psbt)
            assertEquals(psbt.inputs.size, 2)
            assertNotNull(psbt.inputs[0].nonWitnessUtxo)
            assertNotNull(psbt.inputs[1].witnessUtxo)
            assertNotNull(psbt.inputs[1].redeemScript)
            assertEquals(psbt.outputs.size, 2)
            psbt.outputs.forEach { assertTrue(it.derivationPaths.isNotEmpty()) }
            assertEquals(
                psbt.outputs.flatMap { it.derivationPaths.keys }.toSet(),
                setOf(PublicKey.fromHex("02ead596687ca806043edc3de116cdf29d5e9257c196cd055cf698c8d02bf24e99"), PublicKey.fromHex("0394f62be9df19952c5587768aeb7698061ad2c4a25c894f47d8c162b4d7213d05"))
            )
            assertEquals(psbt.outputs.flatMap { output -> output.derivationPaths.values.map { it.masterKeyFingerprint } }.toSet(), setOf(3030825575L))
            assertEquals(Psbt.write(psbt), bin)
        }
        run {
            // PSBT with one P2SH-P2WSH input of a 2-of-2 multisig, redeemScript, witnessScript, and keypaths are available. Contains one signature.
            val bin = ByteVector(
                "70736274ff0100550200000001279a2323a5dfb51fc45f220fa58b0fc13e1e3342792a85d7e36cd6333b5cbc390000000000ffffffff01a05aea0b000000001976a914ffe9c0061097cc3b636f2cb0460fa4fc427d2b4588ac0000000000010120955eea0b0000000017a9146345200f68d189e1adc0df1c4d16ea8f14c0dbeb87220203b1341ccba7683b6af4f1238cd6e97e7167d569fac47f1e48d47541844355bd4646304302200424b58effaaa694e1559ea5c93bbfd4a89064224055cdf070b6771469442d07021f5c8eb0fea6516d60b8acb33ad64ede60e8785bfb3aa94b99bdf86151db9a9a010104220020771fd18ad459666dd49f3d564e3dbc42f4c84774e360ada16816a8ed488d5681010547522103b1341ccba7683b6af4f1238cd6e97e7167d569fac47f1e48d47541844355bd462103de55d1e1dac805e3f8a58c1fbf9b94c02f3dbaafe127fefca4995f26f82083bd52ae220603b1341ccba7683b6af4f1238cd6e97e7167d569fac47f1e48d47541844355bd4610b4a6ba67000000800000008004000080220603de55d1e1dac805e3f8a58c1fbf9b94c02f3dbaafe127fefca4995f26f82083bd10b4a6ba670000008000000080050000800000"
            )
            val result = Psbt.read(bin)
            assertTrue(result.isRight)
            val psbt = result.right!!
            verifyNoUnknown(psbt)
            assertEquals(psbt.inputs.size, 1)
            val pk1 = PublicKey.fromHex("03b1341ccba7683b6af4f1238cd6e97e7167d569fac47f1e48d47541844355bd46")
            val pk2 = PublicKey.fromHex("03de55d1e1dac805e3f8a58c1fbf9b94c02f3dbaafe127fefca4995f26f82083bd")
            assertEquals(psbt.inputs[0].derivationPaths.keys, setOf(pk1, pk2))
            assertEquals(psbt.inputs[0].partialSigs.keys, setOf(pk1))
            assertEquals(psbt.inputs[0].witnessScript, Script.createMultiSigMofN(2, listOf(pk1, pk2)))
            assertEquals(psbt.inputs[0].redeemScript, Script.pay2wsh(psbt.inputs[0].witnessScript!!))
            assertNull(psbt.inputs[0].nonWitnessUtxo)
            assertEquals(psbt.inputs[0].witnessUtxo?.publicKeyScript, ByteVector(Script.write(Script.pay2sh(Script.write(psbt.inputs[0].redeemScript!!)))))
            assertEquals(psbt.outputs.size, 1)
            verifyEmptyOutput(psbt.outputs[0])
            assertEquals(Psbt.write(psbt), bin)
        }
        run {
            // PSBT with one P2WSH input of a 2-of-2 multisig. witnessScript, keypaths, and global xpubs are available. Contains no signatures. Outputs filled.
            val bin = ByteVector(
                "70736274ff01005202000000019dfc6628c26c5899fe1bd3dc338665bfd55d7ada10f6220973df2d386dec12760100000000ffffffff01f03dcd1d000000001600147b3a00bfdc14d27795c2b74901d09da6ef133579000000004f01043587cf02da3fd0088000000097048b1ad0445b1ec8275517727c87b4e4ebc18a203ffa0f94c01566bd38e9000351b743887ee1d40dc32a6043724f2d6459b3b5a4d73daec8fbae0472f3bc43e20cd90c6a4fae000080000000804f01043587cf02da3fd00880000001b90452427139cd78c2cff2444be353cd58605e3e513285e528b407fae3f6173503d30a5e97c8adbc557dac2ad9a7e39c1722ebac69e668b6f2667cc1d671c83cab0cd90c6a4fae000080010000800001012b0065cd1d000000002200202c5486126c4978079a814e13715d65f36459e4d6ccaded266d0508645bafa6320105475221029da12cdb5b235692b91536afefe5c91c3ab9473d8e43b533836ab456299c88712103372b34234ed7cf9c1fea5d05d441557927be9542b162eb02e1ab2ce80224c00b52ae2206029da12cdb5b235692b91536afefe5c91c3ab9473d8e43b533836ab456299c887110d90c6a4fae0000800000008000000000220603372b34234ed7cf9c1fea5d05d441557927be9542b162eb02e1ab2ce80224c00b10d90c6a4fae0000800100008000000000002202039eff1f547a1d5f92dfa2ba7af6ac971a4bd03ba4a734b03156a256b8ad3a1ef910ede45cc500000080000000800100008000"
            )
            val result = Psbt.read(bin)
            assertTrue(result.isRight)
            val psbt = result.right!!
            verifyNoUnknown(psbt)
            assertEquals(
                psbt.global.extendedPublicKeys.map { it.extendedPublicKey.publicKey }.toSet(),
                setOf(PublicKey.fromHex("03d30a5e97c8adbc557dac2ad9a7e39c1722ebac69e668b6f2667cc1d671c83cab"), PublicKey.fromHex("0351b743887ee1d40dc32a6043724f2d6459b3b5a4d73daec8fbae0472f3bc43e2"))
            )
            assertEquals(psbt.inputs.size, 1)
            val pk1 = PublicKey.fromHex("029da12cdb5b235692b91536afefe5c91c3ab9473d8e43b533836ab456299c8871")
            val pk2 = PublicKey.fromHex("03372b34234ed7cf9c1fea5d05d441557927be9542b162eb02e1ab2ce80224c00b")
            assertNull(psbt.inputs[0].nonWitnessUtxo)
            assertNull(psbt.inputs[0].redeemScript)
            assertEquals(psbt.inputs[0].derivationPaths.keys, setOf(pk1, pk2))
            assertEquals(psbt.inputs[0].witnessScript, Script.createMultiSigMofN(2, listOf(pk1, pk2)))
            assertEquals(psbt.inputs[0].witnessUtxo?.publicKeyScript, ByteVector(Script.write(Script.pay2wsh(psbt.inputs[0].witnessScript!!))))
            assertTrue(psbt.inputs[0].partialSigs.isEmpty())
            assertEquals(psbt.outputs.size, 1)
            assertNull(psbt.outputs[0].redeemScript)
            assertNull(psbt.outputs[0].witnessScript)
            assertEquals(psbt.outputs[0].derivationPaths.keys, setOf(PublicKey.fromHex("039eff1f547a1d5f92dfa2ba7af6ac971a4bd03ba4a734b03156a256b8ad3a1ef9")))
            // NB: we don't fully compare the encoded values because in this particular test vector, the BIP doesn't sort public keys lexicographically
            // so our result differs in the `derivationPaths` section.
            assertEquals(Psbt.write(psbt).size(), bin.size())
        }
        run {
            // PSBT with unknown types in the inputs.
            val bin = ByteVector("70736274ff01003f0200000001ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000ffffffff010000000000000000036a010000000000000af00102030405060708090f0102030405060708090a0b0c0d0e0f0000")
            val result = Psbt.read(bin)
            assertTrue(result.isRight)
            val psbt = result.right!!
            assertTrue(psbt.global.unknown.isEmpty())
            assertEquals(psbt.inputs.size, 1)
            assertTrue(psbt.inputs[0].unknown.isNotEmpty())
            assertEquals(psbt.outputs.size, 1)
            verifyEmptyOutput(psbt.outputs[0])
            assertEquals(Psbt.write(psbt), bin)
        }
        run {
            // PSBT with `PSBT_GLOBAL_XPUB`.
            val bin = ByteVector(
                "70736274ff01009d0100000002710ea76ab45c5cb6438e607e59cc037626981805ae9e0dfd9089012abb0be5350100000000ffffffff190994d6a8b3c8c82ccbcfb2fba4106aa06639b872a8d447465c0d42588d6d670000000000ffffffff0200e1f505000000001976a914b6bc2c0ee5655a843d79afedd0ccc3f7dd64340988ac605af405000000001600141188ef8e4ce0449eaac8fb141cbf5a1176e6a088000000004f010488b21e039e530cac800000003dbc8a5c9769f031b17e77fea1518603221a18fd18f2b9a54c6c8c1ac75cbc3502f230584b155d1c7f1cd45120a653c48d650b431b67c5b2c13f27d7142037c1691027569c503100008000000080000000800001011f00e1f5050000000016001433b982f91b28f160c920b4ab95e58ce50dda3a4a220203309680f33c7de38ea6a47cd4ecd66f1f5a49747c6ffb8808ed09039243e3ad5c47304402202d704ced830c56a909344bd742b6852dccd103e963bae92d38e75254d2bb424502202d86c437195df46c0ceda084f2a291c3da2d64070f76bf9b90b195e7ef28f77201220603309680f33c7de38ea6a47cd4ecd66f1f5a49747c6ffb8808ed09039243e3ad5c1827569c5031000080000000800000008000000000010000000001011f00e1f50500000000160014388fb944307eb77ef45197d0b0b245e079f011de220202c777161f73d0b7c72b9ee7bde650293d13f095bc7656ad1f525da5fd2e10b11047304402204cb1fb5f869c942e0e26100576125439179ae88dca8a9dc3ba08f7953988faa60220521f49ca791c27d70e273c9b14616985909361e25be274ea200d7e08827e514d01220602c777161f73d0b7c72b9ee7bde650293d13f095bc7656ad1f525da5fd2e10b1101827569c5031000080000000800000008000000000000000000000220202d20ca502ee289686d21815bd43a80637b0698e1fbcdbe4caed445f6c1a0a90ef1827569c50310000800000008000000080000000000400000000"
            )
            val result = Psbt.read(bin)
            assertTrue(result.isRight)
            val psbt = result.right!!
            verifyNoUnknown(psbt)
            assertEquals(psbt.global.extendedPublicKeys.map { it.extendedPublicKey.publicKey }, listOf(PublicKey.fromHex("02f230584b155d1c7f1cd45120a653c48d650b431b67c5b2c13f27d7142037c169")))
            assertEquals(psbt.inputs.size, 2)
            psbt.inputs.forEach { input ->
                assertEquals(input.partialSigs.size, 1)
                assertEquals(input.derivationPaths.size, 1)
            }
            assertEquals(psbt.outputs.size, 2)
            verifyEmptyOutput(psbt.outputs[0])
            assertEquals(psbt.outputs[1].derivationPaths, mapOf(PublicKey.fromHex("02d20ca502ee289686d21815bd43a80637b0698e1fbcdbe4caed445f6c1a0a90ef") to KeyPathWithMaster(659987536, KeyPath("m/49'/0'/0'/0/4"))))
            assertEquals(Psbt.write(psbt), bin)
        }
        run {
            // PSBT with global unsigned tx that has 0 inputs and 0 outputs
            val bin = ByteVector("70736274ff01000a0000000000000000000000")
            val result = Psbt.read(bin)
            assertTrue(result.isRight)
            val psbt = result.right!!
            assertTrue(psbt.global.tx.txIn.isEmpty())
            assertTrue(psbt.global.tx.txOut.isEmpty())
            assertTrue(psbt.inputs.isEmpty())
            assertTrue(psbt.outputs.isEmpty())
            assertEquals(Psbt.write(psbt), bin)
        }
        run {
            // PSBT with 0 inputs
            val bin = ByteVector("70736274ff01004c020000000002d3dff505000000001976a914d0c59903c5bac2868760e90fd521a4665aa7652088ac00e1f5050000000017a9143545e6e33b832c47050f24d3eeb93c9c03948bc787b32e1300000000")
            val result = Psbt.read(bin)
            assertTrue(result.isRight)
            val psbt = result.right!!
            verifyNoUnknown(psbt)
            assertTrue(psbt.inputs.isEmpty())
            assertEquals(psbt.outputs.size, 2)
            psbt.outputs.forEach { verifyEmptyOutput(it) }
            assertEquals(Psbt.write(psbt), bin)
        }
    }

    @Test
    fun `fails signer checks -- official test vectors`() {
        class TestCase(val hex: String, val inputIndex: Int, val expected: UpdateFailure)

        val testCases = listOf(
            // A witness UTXO is provided for a non-witness input
            TestCase(
                "70736274ff0100a00200000002ab0949a08c5af7c49b8212f417e2f15ab3f5c33dcf153821a8139f877a5b7be40000000000feffffffab0949a08c5af7c49b8212f417e2f15ab3f5c33dcf153821a8139f877a5b7be40100000000feffffff02603bea0b000000001976a914768a40bbd740cbe81d988e71de2a4d5c71396b1d88ac8e240000000000001976a9146f4620b553fa095e721b9ee0efe9fa039cca459788ac0000000000010122d3dff505000000001976a914d48ed3110b94014cb114bd32d6f4d066dc74256b88ac0001012000e1f5050000000017a9143545e6e33b832c47050f24d3eeb93c9c03948bc787010416001485d13537f2e265405a34dbafa9e3dda01fb8230800220202ead596687ca806043edc3de116cdf29d5e9257c196cd055cf698c8d02bf24e9910b4a6ba670000008000000080020000800022020394f62be9df19952c5587768aeb7698061ad2c4a25c894f47d8c162b4d7213d0510b4a6ba6700000080010000800200008000",
                0,
                UpdateFailure.InvalidWitnessUtxo("witness utxo must use native segwit or P2SH embedded segwit")
            ),
            // redeemScript with non-witness UTXO does not match the scriptPubKey
            TestCase(
                "70736274ff01009a020000000258e87a21b56daf0c23be8e7070456c336f7cbaa5c8757924f545887bb2abdd750000000000ffffffff838d0427d0ec650a68aa46bb0b098aea4422c071b2ca78352a077959d07cea1d0100000000ffffffff0270aaf00800000000160014d85c2b71d0060b09c9886aeb815e50991dda124d00e1f5050000000016001400aea9a2e5f0f876a588df5546e8742d1d87008f00000000000100bb0200000001aad73931018bd25f84ae400b68848be09db706eac2ac18298babee71ab656f8b0000000048473044022058f6fc7c6a33e1b31548d481c826c015bd30135aad42cd67790dab66d2ad243b02204a1ced2604c6735b6393e5b41691dd78b00f0c5942fb9f751856faa938157dba01feffffff0280f0fa020000000017a9140fb9463421696b82c833af241c78c17ddbde493487d0f20a270100000017a91429ca74f8a08f81999428185c97b5d852e4063f618765000000220202dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d7483045022100f61038b308dc1da865a34852746f015772934208c6d24454393cd99bdf2217770220056e675a675a6d0a02b85b14e5e29074d8a25a9b5760bea2816f661910a006ea01010304010000000104475221029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f2102dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d752af2206029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f10d90c6a4f000000800000008000000080220602dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d710d90c6a4f0000008000000080010000800001012000c2eb0b0000000017a914b7f5faf40e3d40a5a459b1db3535f2b72fa921e8872202023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e73473044022065f45ba5998b59a27ffe1a7bed016af1f1f90d54b3aa8f7450aa5f56a25103bd02207f724703ad1edb96680b284b56d4ffcb88f7fb759eabbe08aa30f29b851383d2010103040100000001042200208c2353173743b595dfb4a07b72ba8e42e3797da74e87fe7d9d7497e3b2028903010547522103089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc21023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7352ae2206023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7310d90c6a4f000000800000008003000080220603089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc10d90c6a4f00000080000000800200008000220203a9a4c37f5996d3aa25dbac6b570af0650394492942460b354753ed9eeca5877110d90c6a4f000000800000008004000080002202027f6399757d2eff55a136ad02c684b1838b6556e5f1b6b34282a94b6b5005109610d90c6a4f00000080000000800500008000",
                0,
                UpdateFailure.InvalidNonWitnessUtxo("redeem script does not match non-witness utxo scriptPubKey")
            ),
            // redeemScript with witness UTXO does not match the scriptPubKey
            TestCase(
                "70736274ff01009a020000000258e87a21b56daf0c23be8e7070456c336f7cbaa5c8757924f545887bb2abdd750000000000ffffffff838d0427d0ec650a68aa46bb0b098aea4422c071b2ca78352a077959d07cea1d0100000000ffffffff0270aaf00800000000160014d85c2b71d0060b09c9886aeb815e50991dda124d00e1f5050000000016001400aea9a2e5f0f876a588df5546e8742d1d87008f00000000000100bb0200000001aad73931018bd25f84ae400b68848be09db706eac2ac18298babee71ab656f8b0000000048473044022058f6fc7c6a33e1b31548d481c826c015bd30135aad42cd67790dab66d2ad243b02204a1ced2604c6735b6393e5b41691dd78b00f0c5942fb9f751856faa938157dba01feffffff0280f0fa020000000017a9140fb9463421696b82c833af241c78c17ddbde493487d0f20a270100000017a91429ca74f8a08f81999428185c97b5d852e4063f618765000000220202dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d7483045022100f61038b308dc1da865a34852746f015772934208c6d24454393cd99bdf2217770220056e675a675a6d0a02b85b14e5e29074d8a25a9b5760bea2816f661910a006ea01010304010000000104475221029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f2102dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d752ae2206029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f10d90c6a4f000000800000008000000080220602dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d710d90c6a4f0000008000000080010000800001012000c2eb0b0000000017a914b7f5faf40e3d40a5a459b1db3535f2b72fa921e8872202023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e73473044022065f45ba5998b59a27ffe1a7bed016af1f1f90d54b3aa8f7450aa5f56a25103bd02207f724703ad1edb96680b284b56d4ffcb88f7fb759eabbe08aa30f29b851383d2010103040100000001042200208c2353173743b595dfb4a07b72ba8e42e3797da74e87fe7d9d7497e3b2028900010547522103089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc21023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7352ae2206023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7310d90c6a4f000000800000008003000080220603089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc10d90c6a4f00000080000000800200008000220203a9a4c37f5996d3aa25dbac6b570af0650394492942460b354753ed9eeca5877110d90c6a4f000000800000008004000080002202027f6399757d2eff55a136ad02c684b1838b6556e5f1b6b34282a94b6b5005109610d90c6a4f00000080000000800500008000",
                1,
                UpdateFailure.InvalidWitnessUtxo("redeem script does not match witness utxo scriptPubKey")
            ),
            // witnessScript with witness UTXO does not match the redeemScript
            TestCase(
                "70736274ff01009a020000000258e87a21b56daf0c23be8e7070456c336f7cbaa5c8757924f545887bb2abdd750000000000ffffffff838d0427d0ec650a68aa46bb0b098aea4422c071b2ca78352a077959d07cea1d0100000000ffffffff0270aaf00800000000160014d85c2b71d0060b09c9886aeb815e50991dda124d00e1f5050000000016001400aea9a2e5f0f876a588df5546e8742d1d87008f00000000000100bb0200000001aad73931018bd25f84ae400b68848be09db706eac2ac18298babee71ab656f8b0000000048473044022058f6fc7c6a33e1b31548d481c826c015bd30135aad42cd67790dab66d2ad243b02204a1ced2604c6735b6393e5b41691dd78b00f0c5942fb9f751856faa938157dba01feffffff0280f0fa020000000017a9140fb9463421696b82c833af241c78c17ddbde493487d0f20a270100000017a91429ca74f8a08f81999428185c97b5d852e4063f618765000000220202dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d7483045022100f61038b308dc1da865a34852746f015772934208c6d24454393cd99bdf2217770220056e675a675a6d0a02b85b14e5e29074d8a25a9b5760bea2816f661910a006ea01010304010000000104475221029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f2102dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d752ae2206029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f10d90c6a4f000000800000008000000080220602dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d710d90c6a4f0000008000000080010000800001012000c2eb0b0000000017a914b7f5faf40e3d40a5a459b1db3535f2b72fa921e8872202023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e73473044022065f45ba5998b59a27ffe1a7bed016af1f1f90d54b3aa8f7450aa5f56a25103bd02207f724703ad1edb96680b284b56d4ffcb88f7fb759eabbe08aa30f29b851383d2010103040100000001042200208c2353173743b595dfb4a07b72ba8e42e3797da74e87fe7d9d7497e3b2028903010547522103089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc21023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7352ad2206023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7310d90c6a4f000000800000008003000080220603089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc10d90c6a4f00000080000000800200008000220203a9a4c37f5996d3aa25dbac6b570af0650394492942460b354753ed9eeca5877110d90c6a4f000000800000008004000080002202027f6399757d2eff55a136ad02c684b1838b6556e5f1b6b34282a94b6b5005109610d90c6a4f00000080000000800500008000",
                1,
                UpdateFailure.InvalidWitnessUtxo("witness script does not match redeemScript or scriptPubKey")
            )
        )
        testCases.forEach {
            val result = Psbt.read(Hex.decode(it.hex))
            assertTrue(result.isRight)
            val signed = result.right!!.sign(masterPrivKey.privateKey, it.inputIndex)
            assertEquals(signed, Either.Left(it.expected))
        }
    }

    @Test
    fun `create PSBT -- official test vectors`() {
        val unsignedTx = Transaction(
            version = 2,
            txIn = listOf(
                TxIn(OutPoint(TxId("75ddabb27b8845f5247975c8a5ba7c6f336c4570708ebe230caf6db5217ae858"), 0), listOf(), TxIn.SEQUENCE_FINAL),
                TxIn(OutPoint(TxId("1dea7cd05979072a3578cab271c02244ea8a090bbb46aa680a65ecd027048d83"), 1), listOf(), TxIn.SEQUENCE_FINAL)
            ),
            txOut = listOf(
                TxOut(149_990_000.toSatoshi(), ByteVector("0014d85c2b71d0060b09c9886aeb815e50991dda124d")),
                TxOut(100_000_000.toSatoshi(), ByteVector("001400aea9a2e5f0f876a588df5546e8742d1d87008f"))
            ),
            lockTime = 0
        )
        val psbt = Psbt(unsignedTx)
        assertEquals(
            Psbt.write(psbt),
            ByteVector("70736274ff01009a020000000258e87a21b56daf0c23be8e7070456c336f7cbaa5c8757924f545887bb2abdd750000000000ffffffff838d0427d0ec650a68aa46bb0b098aea4422c071b2ca78352a077959d07cea1d0100000000ffffffff0270aaf00800000000160014d85c2b71d0060b09c9886aeb815e50991dda124d00e1f5050000000016001400aea9a2e5f0f876a588df5546e8742d1d87008f000000000000000000")
        )
    }

    @Test
    fun `update PSBT -- official test vectors`() {
        val firstInputTx = Transaction.read(
            "0200000001aad73931018bd25f84ae400b68848be09db706eac2ac18298babee71ab656f8b0000000048473044022058f6fc7c6a33e1b31548d481c826c015bd30135aad42cd67790dab66d2ad243b02204a1ced2604c6735b6393e5b41691dd78b00f0c5942fb9f751856faa938157dba01feffffff0280f0fa020000000017a9140fb9463421696b82c833af241c78c17ddbde493487d0f20a270100000017a91429ca74f8a08f81999428185c97b5d852e4063f618765000000"
        )
        val firstInputIndex = 0
        val secondInputTx = Transaction.read(
            "0200000000010158e87a21b56daf0c23be8e7070456c336f7cbaa5c8757924f545887bb2abdd7501000000171600145f275f436b09a8cc9a2eb2a2f528485c68a56323feffffff02d8231f1b0100000017a914aed962d6654f9a2b36608eb9d64d2b260db4f1118700c2eb0b0000000017a914b7f5faf40e3d40a5a459b1db3535f2b72fa921e88702483045022100a22edcc6e5bc511af4cc4ae0de0fcd75c7e04d8c1c3a8aa9d820ed4b967384ec02200642963597b9b1bc22c75e9f3e117284a962188bf5e8a74c895089046a20ad770121035509a48eb623e10aace8bfd0212fdb8a8e5af3c94b0b133b95e114cab89e4f7965000000"
        )
        val secondInputIndex = 1
        // Updated PSBT from the previous step.
        val psbt = readValidPsbt(
            "70736274ff01009a020000000258e87a21b56daf0c23be8e7070456c336f7cbaa5c8757924f545887bb2abdd750000000000ffffffff838d0427d0ec650a68aa46bb0b098aea4422c071b2ca78352a077959d07cea1d0100000000ffffffff0270aaf00800000000160014d85c2b71d0060b09c9886aeb815e50991dda124d00e1f5050000000016001400aea9a2e5f0f876a588df5546e8742d1d87008f000000000000000000"
        )
        // Update input 1 with a non-witness multi-sig utxo:
        val updated = psbt.updateNonWitnessInput(
            firstInputTx,
            firstInputIndex,
            Script.createMultiSigMofN(2, listOf(PublicKey.fromHex("029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f"), PublicKey.fromHex("02dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d7"))),
            derivationPaths = mapOf(
                PublicKey.fromHex("029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f") to KeyPathWithMaster(DeterministicWallet.fingerprint(masterPrivKey), KeyPath("m/0'/0'/0'")),
                PublicKey.fromHex("02dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d7") to KeyPathWithMaster(DeterministicWallet.fingerprint(masterPrivKey), KeyPath("m/0'/0'/1'"))
            )
        ).flatMap {
            // Update input 2 with a witness multi-sig utxo:
            it.updateWitnessInputTx(
                secondInputTx,
                secondInputIndex,
                Script.pay2wsh(
                    Script.createMultiSigMofN(
                        2,
                        listOf(PublicKey.fromHex("03089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc"), PublicKey.fromHex("023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e73"))
                    )
                ),
                Script.createMultiSigMofN(2, listOf(PublicKey.fromHex("03089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc"), PublicKey.fromHex("023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e73"))),
                derivationPaths = mapOf(
                    PublicKey.fromHex("03089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc") to KeyPathWithMaster(DeterministicWallet.fingerprint(masterPrivKey), KeyPath("m/0'/0'/2'")),
                    PublicKey.fromHex("023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e73") to KeyPathWithMaster(DeterministicWallet.fingerprint(masterPrivKey), KeyPath("m/0'/0'/3'"))
                )
            )
        }.flatMap {
            // Update first output with known derivation paths:
            val paths = mapOf(
                PublicKey.fromHex("03a9a4c37f5996d3aa25dbac6b570af0650394492942460b354753ed9eeca58771") to KeyPathWithMaster(DeterministicWallet.fingerprint(masterPrivKey), KeyPath("m/0'/0'/4'"))
            )
            it.updateNonWitnessOutput(0, derivationPaths = paths)
        }.flatMap {
            // Update second output with known derivation paths:
            val paths = mapOf(
                PublicKey.fromHex("027f6399757d2eff55a136ad02c684b1838b6556e5f1b6b34282a94b6b50051096") to KeyPathWithMaster(DeterministicWallet.fingerprint(masterPrivKey), KeyPath("m/0'/0'/5'"))
            )
            it.updateWitnessOutput(1, derivationPaths = paths)
        }
        assertTrue(updated.isRight)

        // We differ from the official test vector because we include both witnessUtxo and nonWitnessUtxo, because of https://github.com/bitcoin/bips/blob/master/bip-0174.mediawiki#cite_note-8
        assertEquals(
            Psbt.write(updated.right!!),
            ByteVector(
                "70736274ff01009a020000000258e87a21b56daf0c23be8e7070456c336f7cbaa5c8757924f545887bb2abdd750000000000ffffffff838d0427d0ec650a68aa46bb0b098aea4422c071b2ca78352a077959d07cea1d0100000000ffffffff0270aaf00800000000160014d85c2b71d0060b09c9886aeb815e50991dda124d00e1f5050000000016001400aea9a2e5f0f876a588df5546e8742d1d87008f00000000000100bb0200000001aad73931018bd25f84ae400b68848be09db706eac2ac18298babee71ab656f8b0000000048473044022058f6fc7c6a33e1b31548d481c826c015bd30135aad42cd67790dab66d2ad243b02204a1ced2604c6735b6393e5b41691dd78b00f0c5942fb9f751856faa938157dba01feffffff0280f0fa020000000017a9140fb9463421696b82c833af241c78c17ddbde493487d0f20a270100000017a91429ca74f8a08f81999428185c97b5d852e4063f6187650000000104475221029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f2102dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d752ae2206029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f10d90c6a4f000000800000008000000080220602dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d710d90c6a4f000000800000008001000080000100f80200000000010158e87a21b56daf0c23be8e7070456c336f7cbaa5c8757924f545887bb2abdd7501000000171600145f275f436b09a8cc9a2eb2a2f528485c68a56323feffffff02d8231f1b0100000017a914aed962d6654f9a2b36608eb9d64d2b260db4f1118700c2eb0b0000000017a914b7f5faf40e3d40a5a459b1db3535f2b72fa921e88702483045022100a22edcc6e5bc511af4cc4ae0de0fcd75c7e04d8c1c3a8aa9d820ed4b967384ec02200642963597b9b1bc22c75e9f3e117284a962188bf5e8a74c895089046a20ad770121035509a48eb623e10aace8bfd0212fdb8a8e5af3c94b0b133b95e114cab89e4f796500000001012000c2eb0b0000000017a914b7f5faf40e3d40a5a459b1db3535f2b72fa921e88701042200208c2353173743b595dfb4a07b72ba8e42e3797da74e87fe7d9d7497e3b2028903010547522103089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc21023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7352ae2206023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7310d90c6a4f000000800000008003000080220603089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc10d90c6a4f00000080000000800200008000220203a9a4c37f5996d3aa25dbac6b570af0650394492942460b354753ed9eeca5877110d90c6a4f000000800000008004000080002202027f6399757d2eff55a136ad02c684b1838b6556e5f1b6b34282a94b6b5005109610d90c6a4f00000080000000800500008000"
            )
        )
        // But if we remove the nonWitnessUtxo in the second input, we match the official test vector:
        val withOnlyWitnessUtxo = updated.right!!.copy(inputs = listOf(updated.right!!.inputs[0], (updated.right!!.inputs[1] as Input.WitnessInput.PartiallySignedWitnessInput).copy(nonWitnessUtxo = null)))
        assertEquals(
            Psbt.write(withOnlyWitnessUtxo),
            ByteVector(
                "70736274ff01009a020000000258e87a21b56daf0c23be8e7070456c336f7cbaa5c8757924f545887bb2abdd750000000000ffffffff838d0427d0ec650a68aa46bb0b098aea4422c071b2ca78352a077959d07cea1d0100000000ffffffff0270aaf00800000000160014d85c2b71d0060b09c9886aeb815e50991dda124d00e1f5050000000016001400aea9a2e5f0f876a588df5546e8742d1d87008f00000000000100bb0200000001aad73931018bd25f84ae400b68848be09db706eac2ac18298babee71ab656f8b0000000048473044022058f6fc7c6a33e1b31548d481c826c015bd30135aad42cd67790dab66d2ad243b02204a1ced2604c6735b6393e5b41691dd78b00f0c5942fb9f751856faa938157dba01feffffff0280f0fa020000000017a9140fb9463421696b82c833af241c78c17ddbde493487d0f20a270100000017a91429ca74f8a08f81999428185c97b5d852e4063f6187650000000104475221029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f2102dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d752ae2206029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f10d90c6a4f000000800000008000000080220602dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d710d90c6a4f0000008000000080010000800001012000c2eb0b0000000017a914b7f5faf40e3d40a5a459b1db3535f2b72fa921e88701042200208c2353173743b595dfb4a07b72ba8e42e3797da74e87fe7d9d7497e3b2028903010547522103089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc21023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7352ae2206023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7310d90c6a4f000000800000008003000080220603089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc10d90c6a4f00000080000000800200008000220203a9a4c37f5996d3aa25dbac6b570af0650394492942460b354753ed9eeca5877110d90c6a4f000000800000008004000080002202027f6399757d2eff55a136ad02c684b1838b6556e5f1b6b34282a94b6b5005109610d90c6a4f00000080000000800500008000"
            )
        )
        // Update inputs to use SIGHASH_ALL:
        val withSighash = withOnlyWitnessUtxo.updateNonWitnessInput(firstInputTx, firstInputIndex, sighashType = SIGHASH_ALL).flatMap {
            it.updateWitnessInput(OutPoint(secondInputTx, secondInputIndex.toLong()), secondInputTx.txOut[secondInputIndex], sighashType = SIGHASH_ALL)
        }
        assertTrue(withSighash.isRight)
        assertEquals(
            Psbt.write(withSighash.right!!),
            ByteVector(
                "70736274ff01009a020000000258e87a21b56daf0c23be8e7070456c336f7cbaa5c8757924f545887bb2abdd750000000000ffffffff838d0427d0ec650a68aa46bb0b098aea4422c071b2ca78352a077959d07cea1d0100000000ffffffff0270aaf00800000000160014d85c2b71d0060b09c9886aeb815e50991dda124d00e1f5050000000016001400aea9a2e5f0f876a588df5546e8742d1d87008f00000000000100bb0200000001aad73931018bd25f84ae400b68848be09db706eac2ac18298babee71ab656f8b0000000048473044022058f6fc7c6a33e1b31548d481c826c015bd30135aad42cd67790dab66d2ad243b02204a1ced2604c6735b6393e5b41691dd78b00f0c5942fb9f751856faa938157dba01feffffff0280f0fa020000000017a9140fb9463421696b82c833af241c78c17ddbde493487d0f20a270100000017a91429ca74f8a08f81999428185c97b5d852e4063f618765000000010304010000000104475221029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f2102dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d752ae2206029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f10d90c6a4f000000800000008000000080220602dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d710d90c6a4f0000008000000080010000800001012000c2eb0b0000000017a914b7f5faf40e3d40a5a459b1db3535f2b72fa921e8870103040100000001042200208c2353173743b595dfb4a07b72ba8e42e3797da74e87fe7d9d7497e3b2028903010547522103089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc21023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7352ae2206023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7310d90c6a4f000000800000008003000080220603089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc10d90c6a4f00000080000000800200008000220203a9a4c37f5996d3aa25dbac6b570af0650394492942460b354753ed9eeca5877110d90c6a4f000000800000008004000080002202027f6399757d2eff55a136ad02c684b1838b6556e5f1b6b34282a94b6b5005109610d90c6a4f00000080000000800500008000"
            )
        )
    }

    @Test
    fun `sign PSBT -- official test vectors`() {
        // Updated PSBT from the previous steps.
        val psbt = readValidPsbt(
            "70736274ff01009a020000000258e87a21b56daf0c23be8e7070456c336f7cbaa5c8757924f545887bb2abdd750000000000ffffffff838d0427d0ec650a68aa46bb0b098aea4422c071b2ca78352a077959d07cea1d0100000000ffffffff0270aaf00800000000160014d85c2b71d0060b09c9886aeb815e50991dda124d00e1f5050000000016001400aea9a2e5f0f876a588df5546e8742d1d87008f00000000000100bb0200000001aad73931018bd25f84ae400b68848be09db706eac2ac18298babee71ab656f8b0000000048473044022058f6fc7c6a33e1b31548d481c826c015bd30135aad42cd67790dab66d2ad243b02204a1ced2604c6735b6393e5b41691dd78b00f0c5942fb9f751856faa938157dba01feffffff0280f0fa020000000017a9140fb9463421696b82c833af241c78c17ddbde493487d0f20a270100000017a91429ca74f8a08f81999428185c97b5d852e4063f618765000000010304010000000104475221029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f2102dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d752ae2206029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f10d90c6a4f000000800000008000000080220602dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d710d90c6a4f0000008000000080010000800001012000c2eb0b0000000017a914b7f5faf40e3d40a5a459b1db3535f2b72fa921e8870103040100000001042200208c2353173743b595dfb4a07b72ba8e42e3797da74e87fe7d9d7497e3b2028903010547522103089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc21023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7352ae2206023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7310d90c6a4f000000800000008003000080220603089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc10d90c6a4f00000080000000800200008000220203a9a4c37f5996d3aa25dbac6b570af0650394492942460b354753ed9eeca5877110d90c6a4f000000800000008004000080002202027f6399757d2eff55a136ad02c684b1838b6556e5f1b6b34282a94b6b5005109610d90c6a4f00000080000000800500008000"
        )

        run {
            // First signer.
            val inputKeys = mapOf(
                0 to DeterministicWallet.derivePrivateKey(masterPrivKey, KeyPath("m/0'/0'/0'")),
                1 to DeterministicWallet.derivePrivateKey(masterPrivKey, KeyPath("m/0'/0'/2'"))
            )
            assertEquals(inputKeys.values.map { it.privateKey.toBase58(Base58.Prefix.SecretKeyTestnet) }.toSet(), setOf("cP53pDbR5WtAD8dYAW9hhTjuvvTVaEiQBdrz9XPrgLBeRFiyCbQr", "cR6SXDoyfQrcp4piaiHE97Rsgta9mNhGTen9XeonVgwsh4iSgw6d"))
            val signed = psbt.sign(inputKeys.getValue(0).privateKey, 0).flatMap { it.psbt.sign(inputKeys.getValue(1).privateKey, 1) }
            assertTrue(signed.isRight)
            assertEquals(
                Psbt.write(signed.right!!.psbt),
                ByteVector(
                    "70736274ff01009a020000000258e87a21b56daf0c23be8e7070456c336f7cbaa5c8757924f545887bb2abdd750000000000ffffffff838d0427d0ec650a68aa46bb0b098aea4422c071b2ca78352a077959d07cea1d0100000000ffffffff0270aaf00800000000160014d85c2b71d0060b09c9886aeb815e50991dda124d00e1f5050000000016001400aea9a2e5f0f876a588df5546e8742d1d87008f00000000000100bb0200000001aad73931018bd25f84ae400b68848be09db706eac2ac18298babee71ab656f8b0000000048473044022058f6fc7c6a33e1b31548d481c826c015bd30135aad42cd67790dab66d2ad243b02204a1ced2604c6735b6393e5b41691dd78b00f0c5942fb9f751856faa938157dba01feffffff0280f0fa020000000017a9140fb9463421696b82c833af241c78c17ddbde493487d0f20a270100000017a91429ca74f8a08f81999428185c97b5d852e4063f6187650000002202029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f473044022074018ad4180097b873323c0015720b3684cc8123891048e7dbcd9b55ad679c99022073d369b740e3eb53dcefa33823c8070514ca55a7dd9544f157c167913261118c01010304010000000104475221029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f2102dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d752ae2206029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f10d90c6a4f000000800000008000000080220602dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d710d90c6a4f0000008000000080010000800001012000c2eb0b0000000017a914b7f5faf40e3d40a5a459b1db3535f2b72fa921e887220203089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc473044022062eb7a556107a7c73f45ac4ab5a1dddf6f7075fb1275969a7f383efff784bcb202200c05dbb7470dbf2f08557dd356c7325c1ed30913e996cd3840945db12228da5f010103040100000001042200208c2353173743b595dfb4a07b72ba8e42e3797da74e87fe7d9d7497e3b2028903010547522103089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc21023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7352ae2206023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7310d90c6a4f000000800000008003000080220603089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc10d90c6a4f00000080000000800200008000220203a9a4c37f5996d3aa25dbac6b570af0650394492942460b354753ed9eeca5877110d90c6a4f000000800000008004000080002202027f6399757d2eff55a136ad02c684b1838b6556e5f1b6b34282a94b6b5005109610d90c6a4f00000080000000800500008000"
                )
            )
        }
        run {
            // Second signer.
            val inputKeys = mapOf(
                0 to DeterministicWallet.derivePrivateKey(masterPrivKey, KeyPath("m/0'/0'/1'")),
                1 to DeterministicWallet.derivePrivateKey(masterPrivKey, KeyPath("m/0'/0'/3'"))
            )
            assertEquals(inputKeys.values.map { it.privateKey.toBase58(Base58.Prefix.SecretKeyTestnet) }.toSet(), setOf("cT7J9YpCwY3AVRFSjN6ukeEeWY6mhpbJPxRaDaP5QTdygQRxP9Au", "cNBc3SWUip9PPm1GjRoLEJT6T41iNzCYtD7qro84FMnM5zEqeJsE"))
            val signed = psbt.sign(inputKeys.getValue(0).privateKey, 0).flatMap { it.psbt.sign(inputKeys.getValue(1).privateKey, 1) }
            assertTrue(signed.isRight)
            assertEquals(
                Psbt.write(signed.right!!.psbt),
                ByteVector(
                    "70736274ff01009a020000000258e87a21b56daf0c23be8e7070456c336f7cbaa5c8757924f545887bb2abdd750000000000ffffffff838d0427d0ec650a68aa46bb0b098aea4422c071b2ca78352a077959d07cea1d0100000000ffffffff0270aaf00800000000160014d85c2b71d0060b09c9886aeb815e50991dda124d00e1f5050000000016001400aea9a2e5f0f876a588df5546e8742d1d87008f00000000000100bb0200000001aad73931018bd25f84ae400b68848be09db706eac2ac18298babee71ab656f8b0000000048473044022058f6fc7c6a33e1b31548d481c826c015bd30135aad42cd67790dab66d2ad243b02204a1ced2604c6735b6393e5b41691dd78b00f0c5942fb9f751856faa938157dba01feffffff0280f0fa020000000017a9140fb9463421696b82c833af241c78c17ddbde493487d0f20a270100000017a91429ca74f8a08f81999428185c97b5d852e4063f618765000000220202dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d7483045022100f61038b308dc1da865a34852746f015772934208c6d24454393cd99bdf2217770220056e675a675a6d0a02b85b14e5e29074d8a25a9b5760bea2816f661910a006ea01010304010000000104475221029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f2102dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d752ae2206029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f10d90c6a4f000000800000008000000080220602dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d710d90c6a4f0000008000000080010000800001012000c2eb0b0000000017a914b7f5faf40e3d40a5a459b1db3535f2b72fa921e8872202023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e73473044022065f45ba5998b59a27ffe1a7bed016af1f1f90d54b3aa8f7450aa5f56a25103bd02207f724703ad1edb96680b284b56d4ffcb88f7fb759eabbe08aa30f29b851383d2010103040100000001042200208c2353173743b595dfb4a07b72ba8e42e3797da74e87fe7d9d7497e3b2028903010547522103089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc21023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7352ae2206023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7310d90c6a4f000000800000008003000080220603089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc10d90c6a4f00000080000000800200008000220203a9a4c37f5996d3aa25dbac6b570af0650394492942460b354753ed9eeca5877110d90c6a4f000000800000008004000080002202027f6399757d2eff55a136ad02c684b1838b6556e5f1b6b34282a94b6b5005109610d90c6a4f00000080000000800500008000"
                )
            )
        }
    }

    @Test
    fun `combine PSBTs -- official test vectors`() {
        val psbt1 = readValidPsbt(
            "70736274ff01009a020000000258e87a21b56daf0c23be8e7070456c336f7cbaa5c8757924f545887bb2abdd750000000000ffffffff838d0427d0ec650a68aa46bb0b098aea4422c071b2ca78352a077959d07cea1d0100000000ffffffff0270aaf00800000000160014d85c2b71d0060b09c9886aeb815e50991dda124d00e1f5050000000016001400aea9a2e5f0f876a588df5546e8742d1d87008f00000000000100bb0200000001aad73931018bd25f84ae400b68848be09db706eac2ac18298babee71ab656f8b0000000048473044022058f6fc7c6a33e1b31548d481c826c015bd30135aad42cd67790dab66d2ad243b02204a1ced2604c6735b6393e5b41691dd78b00f0c5942fb9f751856faa938157dba01feffffff0280f0fa020000000017a9140fb9463421696b82c833af241c78c17ddbde493487d0f20a270100000017a91429ca74f8a08f81999428185c97b5d852e4063f6187650000002202029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f473044022074018ad4180097b873323c0015720b3684cc8123891048e7dbcd9b55ad679c99022073d369b740e3eb53dcefa33823c8070514ca55a7dd9544f157c167913261118c01010304010000000104475221029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f2102dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d752ae2206029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f10d90c6a4f000000800000008000000080220602dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d710d90c6a4f0000008000000080010000800001012000c2eb0b0000000017a914b7f5faf40e3d40a5a459b1db3535f2b72fa921e887220203089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc473044022062eb7a556107a7c73f45ac4ab5a1dddf6f7075fb1275969a7f383efff784bcb202200c05dbb7470dbf2f08557dd356c7325c1ed30913e996cd3840945db12228da5f010103040100000001042200208c2353173743b595dfb4a07b72ba8e42e3797da74e87fe7d9d7497e3b2028903010547522103089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc21023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7352ae2206023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7310d90c6a4f000000800000008003000080220603089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc10d90c6a4f00000080000000800200008000220203a9a4c37f5996d3aa25dbac6b570af0650394492942460b354753ed9eeca5877110d90c6a4f000000800000008004000080002202027f6399757d2eff55a136ad02c684b1838b6556e5f1b6b34282a94b6b5005109610d90c6a4f00000080000000800500008000"
        )
        val psbt2 = readValidPsbt(
            "70736274ff01009a020000000258e87a21b56daf0c23be8e7070456c336f7cbaa5c8757924f545887bb2abdd750000000000ffffffff838d0427d0ec650a68aa46bb0b098aea4422c071b2ca78352a077959d07cea1d0100000000ffffffff0270aaf00800000000160014d85c2b71d0060b09c9886aeb815e50991dda124d00e1f5050000000016001400aea9a2e5f0f876a588df5546e8742d1d87008f00000000000100bb0200000001aad73931018bd25f84ae400b68848be09db706eac2ac18298babee71ab656f8b0000000048473044022058f6fc7c6a33e1b31548d481c826c015bd30135aad42cd67790dab66d2ad243b02204a1ced2604c6735b6393e5b41691dd78b00f0c5942fb9f751856faa938157dba01feffffff0280f0fa020000000017a9140fb9463421696b82c833af241c78c17ddbde493487d0f20a270100000017a91429ca74f8a08f81999428185c97b5d852e4063f618765000000220202dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d7483045022100f61038b308dc1da865a34852746f015772934208c6d24454393cd99bdf2217770220056e675a675a6d0a02b85b14e5e29074d8a25a9b5760bea2816f661910a006ea01010304010000000104475221029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f2102dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d752ae2206029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f10d90c6a4f000000800000008000000080220602dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d710d90c6a4f0000008000000080010000800001012000c2eb0b0000000017a914b7f5faf40e3d40a5a459b1db3535f2b72fa921e8872202023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e73473044022065f45ba5998b59a27ffe1a7bed016af1f1f90d54b3aa8f7450aa5f56a25103bd02207f724703ad1edb96680b284b56d4ffcb88f7fb759eabbe08aa30f29b851383d2010103040100000001042200208c2353173743b595dfb4a07b72ba8e42e3797da74e87fe7d9d7497e3b2028903010547522103089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc21023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7352ae2206023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7310d90c6a4f000000800000008003000080220603089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc10d90c6a4f00000080000000800200008000220203a9a4c37f5996d3aa25dbac6b570af0650394492942460b354753ed9eeca5877110d90c6a4f000000800000008004000080002202027f6399757d2eff55a136ad02c684b1838b6556e5f1b6b34282a94b6b5005109610d90c6a4f00000080000000800500008000"
        )
        val combined = Psbt.combine(psbt1, psbt2)
        assertTrue(combined.isRight)
        // NB: the official test vector doesn't order partial signatures with lexicographic ordering, so we disagree on the order but the content is ok.
        val expectedHex =
            "70736274ff01009a020000000258e87a21b56daf0c23be8e7070456c336f7cbaa5c8757924f545887bb2abdd750000000000ffffffff838d0427d0ec650a68aa46bb0b098aea4422c071b2ca78352a077959d07cea1d0100000000ffffffff0270aaf00800000000160014d85c2b71d0060b09c9886aeb815e50991dda124d00e1f5050000000016001400aea9a2e5f0f876a588df5546e8742d1d87008f00000000000100bb0200000001aad73931018bd25f84ae400b68848be09db706eac2ac18298babee71ab656f8b0000000048473044022058f6fc7c6a33e1b31548d481c826c015bd30135aad42cd67790dab66d2ad243b02204a1ced2604c6735b6393e5b41691dd78b00f0c5942fb9f751856faa938157dba01feffffff0280f0fa020000000017a9140fb9463421696b82c833af241c78c17ddbde493487d0f20a270100000017a91429ca74f8a08f81999428185c97b5d852e4063f6187650000002202029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f473044022074018ad4180097b873323c0015720b3684cc8123891048e7dbcd9b55ad679c99022073d369b740e3eb53dcefa33823c8070514ca55a7dd9544f157c167913261118c01220202dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d7483045022100f61038b308dc1da865a34852746f015772934208c6d24454393cd99bdf2217770220056e675a675a6d0a02b85b14e5e29074d8a25a9b5760bea2816f661910a006ea01010304010000000104475221029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f2102dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d752ae2206029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f10d90c6a4f000000800000008000000080220602dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d710d90c6a4f0000008000000080010000800001012000c2eb0b0000000017a914b7f5faf40e3d40a5a459b1db3535f2b72fa921e887220203089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc473044022062eb7a556107a7c73f45ac4ab5a1dddf6f7075fb1275969a7f383efff784bcb202200c05dbb7470dbf2f08557dd356c7325c1ed30913e996cd3840945db12228da5f012202023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e73473044022065f45ba5998b59a27ffe1a7bed016af1f1f90d54b3aa8f7450aa5f56a25103bd02207f724703ad1edb96680b284b56d4ffcb88f7fb759eabbe08aa30f29b851383d2010103040100000001042200208c2353173743b595dfb4a07b72ba8e42e3797da74e87fe7d9d7497e3b2028903010547522103089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc21023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7352ae2206023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7310d90c6a4f000000800000008003000080220603089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc10d90c6a4f00000080000000800200008000220203a9a4c37f5996d3aa25dbac6b570af0650394492942460b354753ed9eeca5877110d90c6a4f000000800000008004000080002202027f6399757d2eff55a136ad02c684b1838b6556e5f1b6b34282a94b6b5005109610d90c6a4f00000080000000800500008000"
        assertEquals(Psbt.write(combined.right!!).size(), ByteVector(expectedHex).size())
        val expectedPsbt = readValidPsbt(expectedHex)
        for (i in 0..1) {
            assertEquals(combined.right!!.inputs[i].partialSigs.keys, expectedPsbt.inputs[i].partialSigs.keys)
            assertEquals(combined.right!!.inputs[i].partialSigs.values.toSet(), expectedPsbt.inputs[i].partialSigs.values.toSet())
        }
    }

    @Test
    fun `combine PSBTs with unknown keys -- official test vectors`() {
        val psbt1 = readValidPsbt(
            "70736274ff01003f0200000001ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000ffffffff010000000000000000036a0100000000000af00102030405060708090f0102030405060708090a0b0c0d0e0f000af00102030405060708090f0102030405060708090a0b0c0d0e0f000af00102030405060708090f0102030405060708090a0b0c0d0e0f00"
        )
        val psbt2 = readValidPsbt(
            "70736274ff01003f0200000001ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000ffffffff010000000000000000036a0100000000000af00102030405060708100f0102030405060708090a0b0c0d0e0f000af00102030405060708100f0102030405060708090a0b0c0d0e0f000af00102030405060708100f0102030405060708090a0b0c0d0e0f00"
        )
        val combined = Psbt.combine(psbt1, psbt2)
        assertTrue(combined.isRight)
        val expected = ByteVector(
            "70736274ff01003f0200000001ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000ffffffff010000000000000000036a0100000000000af00102030405060708090f0102030405060708090a0b0c0d0e0f0af00102030405060708100f0102030405060708090a0b0c0d0e0f000af00102030405060708090f0102030405060708090a0b0c0d0e0f0af00102030405060708100f0102030405060708090a0b0c0d0e0f000af00102030405060708090f0102030405060708090a0b0c0d0e0f0af00102030405060708100f0102030405060708090a0b0c0d0e0f00"
        )
        assertEquals(Psbt.write(combined.right!!), expected)
    }

    @Test
    fun `combine PSBTs`() {
        val inputTx1 = Transaction(2, listOf(), listOf(TxOut(500.sat(), ByteVector.empty), TxOut(1500.sat(), ByteVector.empty), TxOut(10000.sat(), ByteVector("11223344"))), 0)
        val input1 = OutPoint(inputTx1, 2)
        val inputTx2 = Transaction(2, listOf(), listOf(TxOut(7500.sat(), ByteVector("ff01ee02dd03")), TxOut(250.sat(), ByteVector.empty)), 0)
        val input2 = OutPoint(inputTx2, 0)
        val globalTx = Transaction(2, listOf(TxIn(input1, ByteVector.empty, 0), TxIn(input2, ByteVector.empty, 0)), listOf(TxOut(5000.sat(), ByteVector("01020304")), TxOut(6000.sat(), ByteVector("abcdef"))), 0)
        val psbt1 = Psbt(globalTx).updateWitnessInputTx(
            inputTx1, 2, null, listOf(OP_1), SIGHASH_ALL, mapOf(
                PublicKey.fromHex("03089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc") to KeyPathWithMaster(
                    DeterministicWallet.fingerprint(
                        masterPrivKey
                    ), KeyPath("m/0'/0'/2'")
                )
            )
        )
            .flatMap {
                it.updateNonWitnessInput(inputTx2, 0, listOf(OP_RETURN), SIGHASH_SINGLE)
            }.flatMap {
                it.updateNonWitnessOutput(
                    0, derivationPaths = mapOf(
                        PublicKey.fromHex("03a9a4c37f5996d3aa25dbac6b570af0650394492942460b354753ed9eeca58771") to KeyPathWithMaster(
                            DeterministicWallet.fingerprint(masterPrivKey),
                            KeyPath("m/0'/0'/4'")
                        )
                    )
                )
            }
        val psbt2 = Psbt(globalTx).updateNonWitnessInput(
            inputTx1, 2, listOf(OP_2DROP), SIGHASH_NONE, mapOf(
                PublicKey.fromHex("02dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d7") to KeyPathWithMaster(
                    DeterministicWallet.fingerprint(
                        masterPrivKey
                    ), KeyPath("m/0'/0'/1'")
                )
            )
        ).flatMap {
            it.updateWitnessInputTx(inputTx2, 0, null, listOf(OP_8))
        }
        val psbt3 = Psbt(globalTx).updateNonWitnessOutput(
            0, listOf(OP_DIV), mapOf(
                PublicKey.fromHex("027f6399757d2eff55a136ad02c684b1838b6556e5f1b6b34282a94b6b50051096") to KeyPathWithMaster(
                    DeterministicWallet.fingerprint(masterPrivKey),
                    KeyPath("m/0'/0'/5'")
                )
            )
        ).flatMap {
            it.updateWitnessOutput(1, listOf(OP_4), listOf(OP_ADD))
        }
        val combined = Psbt.combine(psbt1.right!!, psbt2.right!!, psbt3.right!!)
        assertTrue(combined.isRight)
        val expected = Psbt(
            Global(0, globalTx, listOf(), listOf()),
            listOf(
                Input.WitnessInput.PartiallySignedWitnessInput(
                    inputTx1.txOut[2],
                    inputTx1,
                    SIGHASH_ALL,
                    mapOf(),
                    mapOf(
                        PublicKey.fromHex("02dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d7") to KeyPathWithMaster(DeterministicWallet.fingerprint(masterPrivKey), KeyPath("m/0'/0'/1'")),
                        PublicKey.fromHex("03089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc") to KeyPathWithMaster(DeterministicWallet.fingerprint(masterPrivKey), KeyPath("m/0'/0'/2'")),
                    ),
                    listOf(OP_2DROP),
                    listOf(OP_1),
                    setOf(), setOf(), setOf(), setOf(), listOf()
                ),
                Input.WitnessInput.PartiallySignedWitnessInput(
                    inputTx2.txOut[0],
                    inputTx2,
                    SIGHASH_SINGLE,
                    mapOf(),
                    mapOf(),
                    listOf(OP_RETURN),
                    listOf(OP_8),
                    setOf(), setOf(), setOf(), setOf(), listOf()
                )
            ),
            listOf(
                Output.NonWitnessOutput(
                    listOf(OP_DIV),
                    mapOf(
                        PublicKey.fromHex("03a9a4c37f5996d3aa25dbac6b570af0650394492942460b354753ed9eeca58771") to KeyPathWithMaster(DeterministicWallet.fingerprint(masterPrivKey), KeyPath("m/0'/0'/4'")),
                        PublicKey.fromHex("027f6399757d2eff55a136ad02c684b1838b6556e5f1b6b34282a94b6b50051096") to KeyPathWithMaster(DeterministicWallet.fingerprint(masterPrivKey), KeyPath("m/0'/0'/5'")),
                    ),
                    listOf()
                ),
                Output.WitnessOutput(listOf(OP_4), listOf(OP_ADD), mapOf(), listOf())
            )
        )
        assertEquals(combined.right, expected)
    }

    @Test
    fun `finalize PSBT -- official test vectors`() {
        val psbt = readValidPsbt(
            "70736274ff01009a020000000258e87a21b56daf0c23be8e7070456c336f7cbaa5c8757924f545887bb2abdd750000000000ffffffff838d0427d0ec650a68aa46bb0b098aea4422c071b2ca78352a077959d07cea1d0100000000ffffffff0270aaf00800000000160014d85c2b71d0060b09c9886aeb815e50991dda124d00e1f5050000000016001400aea9a2e5f0f876a588df5546e8742d1d87008f00000000000100bb0200000001aad73931018bd25f84ae400b68848be09db706eac2ac18298babee71ab656f8b0000000048473044022058f6fc7c6a33e1b31548d481c826c015bd30135aad42cd67790dab66d2ad243b02204a1ced2604c6735b6393e5b41691dd78b00f0c5942fb9f751856faa938157dba01feffffff0280f0fa020000000017a9140fb9463421696b82c833af241c78c17ddbde493487d0f20a270100000017a91429ca74f8a08f81999428185c97b5d852e4063f6187650000002202029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f473044022074018ad4180097b873323c0015720b3684cc8123891048e7dbcd9b55ad679c99022073d369b740e3eb53dcefa33823c8070514ca55a7dd9544f157c167913261118c01220202dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d7483045022100f61038b308dc1da865a34852746f015772934208c6d24454393cd99bdf2217770220056e675a675a6d0a02b85b14e5e29074d8a25a9b5760bea2816f661910a006ea01010304010000000104475221029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f2102dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d752ae2206029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f10d90c6a4f000000800000008000000080220602dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d710d90c6a4f0000008000000080010000800001012000c2eb0b0000000017a914b7f5faf40e3d40a5a459b1db3535f2b72fa921e887220203089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc473044022062eb7a556107a7c73f45ac4ab5a1dddf6f7075fb1275969a7f383efff784bcb202200c05dbb7470dbf2f08557dd356c7325c1ed30913e996cd3840945db12228da5f012202023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e73473044022065f45ba5998b59a27ffe1a7bed016af1f1f90d54b3aa8f7450aa5f56a25103bd02207f724703ad1edb96680b284b56d4ffcb88f7fb759eabbe08aa30f29b851383d2010103040100000001042200208c2353173743b595dfb4a07b72ba8e42e3797da74e87fe7d9d7497e3b2028903010547522103089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc21023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7352ae2206023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7310d90c6a4f000000800000008003000080220603089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc10d90c6a4f00000080000000800200008000220203a9a4c37f5996d3aa25dbac6b570af0650394492942460b354753ed9eeca5877110d90c6a4f000000800000008004000080002202027f6399757d2eff55a136ad02c684b1838b6556e5f1b6b34282a94b6b5005109610d90c6a4f00000080000000800500008000"
        )
        val finalized0 = run {
            // The first input is a non-witness 2-of-2 multisig:
            val sig1 = psbt.inputs[0].partialSigs.getValue(PublicKey.fromHex("029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f"))
            val sig2 = psbt.inputs[0].partialSigs.getValue(PublicKey.fromHex("02dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d7"))
            val redeemScript = Script.write(psbt.inputs[0].redeemScript!!)
            val scriptSig = listOf(OP_0, OP_PUSHDATA(sig1), OP_PUSHDATA(sig2), OP_PUSHDATA(redeemScript))
            val finalized = psbt.finalizeNonWitnessInput(0, scriptSig)
            assertTrue(finalized.isRight)
            finalized.right!!
        }
        val finalized1 = run {
            // The second input is a P2SH witness program of a 2-of-2 multisig:
            val sig1 = psbt.inputs[1].partialSigs.getValue(PublicKey.fromHex("03089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc"))
            val sig2 = psbt.inputs[1].partialSigs.getValue(PublicKey.fromHex("023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e73"))
            val witnessScript = Script.write(psbt.inputs[1].witnessScript!!)
            val scriptWitness = ScriptWitness(listOf(ByteVector.empty, sig1, sig2, ByteVector(witnessScript)))
            val finalized = finalized0.finalizeWitnessInput(1, scriptWitness)
            assertTrue(finalized.isRight)
            finalized.right!!
        }
        val expected = ByteVector(
            "70736274ff01009a020000000258e87a21b56daf0c23be8e7070456c336f7cbaa5c8757924f545887bb2abdd750000000000ffffffff838d0427d0ec650a68aa46bb0b098aea4422c071b2ca78352a077959d07cea1d0100000000ffffffff0270aaf00800000000160014d85c2b71d0060b09c9886aeb815e50991dda124d00e1f5050000000016001400aea9a2e5f0f876a588df5546e8742d1d87008f00000000000100bb0200000001aad73931018bd25f84ae400b68848be09db706eac2ac18298babee71ab656f8b0000000048473044022058f6fc7c6a33e1b31548d481c826c015bd30135aad42cd67790dab66d2ad243b02204a1ced2604c6735b6393e5b41691dd78b00f0c5942fb9f751856faa938157dba01feffffff0280f0fa020000000017a9140fb9463421696b82c833af241c78c17ddbde493487d0f20a270100000017a91429ca74f8a08f81999428185c97b5d852e4063f6187650000000107da00473044022074018ad4180097b873323c0015720b3684cc8123891048e7dbcd9b55ad679c99022073d369b740e3eb53dcefa33823c8070514ca55a7dd9544f157c167913261118c01483045022100f61038b308dc1da865a34852746f015772934208c6d24454393cd99bdf2217770220056e675a675a6d0a02b85b14e5e29074d8a25a9b5760bea2816f661910a006ea01475221029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f2102dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d752ae0001012000c2eb0b0000000017a914b7f5faf40e3d40a5a459b1db3535f2b72fa921e8870107232200208c2353173743b595dfb4a07b72ba8e42e3797da74e87fe7d9d7497e3b20289030108da0400473044022062eb7a556107a7c73f45ac4ab5a1dddf6f7075fb1275969a7f383efff784bcb202200c05dbb7470dbf2f08557dd356c7325c1ed30913e996cd3840945db12228da5f01473044022065f45ba5998b59a27ffe1a7bed016af1f1f90d54b3aa8f7450aa5f56a25103bd02207f724703ad1edb96680b284b56d4ffcb88f7fb759eabbe08aa30f29b851383d20147522103089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc21023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7352ae00220203a9a4c37f5996d3aa25dbac6b570af0650394492942460b354753ed9eeca5877110d90c6a4f000000800000008004000080002202027f6399757d2eff55a136ad02c684b1838b6556e5f1b6b34282a94b6b5005109610d90c6a4f00000080000000800500008000"
        )
        assertEquals(Psbt.write(finalized1), expected)
    }

    @Test
    fun `extract transaction -- official test vectors`() {
        val psbt = readValidPsbt(
            "70736274ff01009a020000000258e87a21b56daf0c23be8e7070456c336f7cbaa5c8757924f545887bb2abdd750000000000ffffffff838d0427d0ec650a68aa46bb0b098aea4422c071b2ca78352a077959d07cea1d0100000000ffffffff0270aaf00800000000160014d85c2b71d0060b09c9886aeb815e50991dda124d00e1f5050000000016001400aea9a2e5f0f876a588df5546e8742d1d87008f00000000000100bb0200000001aad73931018bd25f84ae400b68848be09db706eac2ac18298babee71ab656f8b0000000048473044022058f6fc7c6a33e1b31548d481c826c015bd30135aad42cd67790dab66d2ad243b02204a1ced2604c6735b6393e5b41691dd78b00f0c5942fb9f751856faa938157dba01feffffff0280f0fa020000000017a9140fb9463421696b82c833af241c78c17ddbde493487d0f20a270100000017a91429ca74f8a08f81999428185c97b5d852e4063f6187650000000107da00473044022074018ad4180097b873323c0015720b3684cc8123891048e7dbcd9b55ad679c99022073d369b740e3eb53dcefa33823c8070514ca55a7dd9544f157c167913261118c01483045022100f61038b308dc1da865a34852746f015772934208c6d24454393cd99bdf2217770220056e675a675a6d0a02b85b14e5e29074d8a25a9b5760bea2816f661910a006ea01475221029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f2102dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d752ae0001012000c2eb0b0000000017a914b7f5faf40e3d40a5a459b1db3535f2b72fa921e8870107232200208c2353173743b595dfb4a07b72ba8e42e3797da74e87fe7d9d7497e3b20289030108da0400473044022062eb7a556107a7c73f45ac4ab5a1dddf6f7075fb1275969a7f383efff784bcb202200c05dbb7470dbf2f08557dd356c7325c1ed30913e996cd3840945db12228da5f01473044022065f45ba5998b59a27ffe1a7bed016af1f1f90d54b3aa8f7450aa5f56a25103bd02207f724703ad1edb96680b284b56d4ffcb88f7fb759eabbe08aa30f29b851383d20147522103089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc21023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7352ae00220203a9a4c37f5996d3aa25dbac6b570af0650394492942460b354753ed9eeca5877110d90c6a4f000000800000008004000080002202027f6399757d2eff55a136ad02c684b1838b6556e5f1b6b34282a94b6b5005109610d90c6a4f00000080000000800500008000"
        )
        val extracted = psbt.extract()
        assertTrue(extracted.isRight)
        val expected = ByteVector(
            "0200000000010258e87a21b56daf0c23be8e7070456c336f7cbaa5c8757924f545887bb2abdd7500000000da00473044022074018ad4180097b873323c0015720b3684cc8123891048e7dbcd9b55ad679c99022073d369b740e3eb53dcefa33823c8070514ca55a7dd9544f157c167913261118c01483045022100f61038b308dc1da865a34852746f015772934208c6d24454393cd99bdf2217770220056e675a675a6d0a02b85b14e5e29074d8a25a9b5760bea2816f661910a006ea01475221029583bf39ae0a609747ad199addd634fa6108559d6c5cd39b4c2183f1ab96e07f2102dab61ff49a14db6a7d02b0cd1fbb78fc4b18312b5b4e54dae4dba2fbfef536d752aeffffffff838d0427d0ec650a68aa46bb0b098aea4422c071b2ca78352a077959d07cea1d01000000232200208c2353173743b595dfb4a07b72ba8e42e3797da74e87fe7d9d7497e3b2028903ffffffff0270aaf00800000000160014d85c2b71d0060b09c9886aeb815e50991dda124d00e1f5050000000016001400aea9a2e5f0f876a588df5546e8742d1d87008f000400473044022062eb7a556107a7c73f45ac4ab5a1dddf6f7075fb1275969a7f383efff784bcb202200c05dbb7470dbf2f08557dd356c7325c1ed30913e996cd3840945db12228da5f01473044022065f45ba5998b59a27ffe1a7bed016af1f1f90d54b3aa8f7450aa5f56a25103bd02207f724703ad1edb96680b284b56d4ffcb88f7fb759eabbe08aa30f29b851383d20147522103089dc10c7ac6db54f91329af617333db388cead0c231f723379d1b99030b02dc21023add904f3d6dcf59ddb906b0dee23529b7ffb9ed50e5e86151926860221f0e7352ae00000000"
        )
        assertEquals(ByteVector(Transaction.write(extracted.right!!)), expected)
    }

    @Test
    fun `join PSBTs`() {
        val input1 = TxIn(OutPoint(TxHash("2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a"), 0), ByteVector("2a"), 42)
        val output1 = TxOut(500.toSatoshi(), ByteVector("2a2a"))
        val psbt1 = Psbt(Transaction(2, listOf(input1), listOf(output1), 0))

        val input2 = TxIn(OutPoint(TxHash("2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a"), 3), ByteVector("2a2a2a"), 0)
        val psbt2 = Psbt(Transaction(2, listOf(input2), listOf(), 0))

        val output2 = TxOut(1200.toSatoshi(), ByteVector("2a2a2a2a2a"))
        val psbt3 = Psbt(Transaction(2, listOf(), listOf(output2), 0))

        val joined = Psbt.join(psbt1, psbt2, psbt3)
        assertTrue(joined.isRight)
        assertEquals(joined.right!!.inputs.size, 2)
        assertEquals(joined.right!!.outputs.size, 2)
        assertEquals(
            joined.right!!.global.tx, Transaction(
                version = 2,
                txIn = listOf(
                    TxIn(OutPoint(TxHash("2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a"), 0), listOf(), 42),
                    TxIn(OutPoint(TxHash("2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a"), 3), listOf(), 0)
                ),
                txOut = listOf(output1, output2),
                lockTime = 0
            )
        )

        assertEquals(Psbt.join(), Either.Left(UpdateFailure.CannotJoin("no psbt provided")))
        assertEquals(Psbt.join(joined.right!!, psbt1), Either.Left(UpdateFailure.CannotJoin("cannot join psbts that spend the same input")))
        assertEquals(Psbt.join(psbt1, psbt2.copy(global = psbt2.global.copy(version = 3))), Either.Left(UpdateFailure.CannotJoin("cannot join psbts with different versions")))
        assertEquals(Psbt.join(psbt1, Psbt(psbt2.global.tx.copy(version = 1))), Either.Left(UpdateFailure.CannotJoin("cannot join psbts with different tx versions")))
        assertEquals(Psbt.join(psbt1, Psbt(psbt2.global.tx.copy(lockTime = 1))), Either.Left(UpdateFailure.CannotJoin("cannot join psbts with different tx lockTime")))
    }

    @Test
    fun `compute fees`() {
        val inputTx1 = Transaction(2, listOf(), listOf(TxOut(500.toSatoshi(), listOf()), TxOut(750.toSatoshi(), listOf())), 0)
        val inputTx2 = Transaction(2, listOf(), listOf(TxOut(800.toSatoshi(), listOf()), TxOut(600.toSatoshi(), listOf())), 0)
        val psbt = Psbt(
            Transaction(
                version = 2,
                txIn = listOf(TxIn(OutPoint(inputTx1, 1), listOf(), 0), TxIn(OutPoint(inputTx2, 0), listOf(), 6)),
                txOut = listOf(TxOut(300.toSatoshi(), listOf()), TxOut(1000.toSatoshi(), listOf())),
                lockTime = 3
            )
        )

        assertNull(psbt.computeFees()) // inputs have not been updated yet
        val oneInput = psbt.updateWitnessInputTx(inputTx1, 1, witnessScript = listOf(OP_RETURN))
        assertTrue(oneInput.isRight)
        assertNull(oneInput.right!!.computeFees()) // second input has not been updated yet
        val bothInputs = oneInput.right!!.updateNonWitnessInput(inputTx2, 0, redeemScript = listOf(OP_RETURN))
        assertTrue(bothInputs.isRight)
        assertEquals(bothInputs.right!!.computeFees(), 250.toSatoshi())
    }

    @Test
    fun `preimage challenges`() {
        val withPreimageChallenges = readValidPsbt(
            "70736274ff01009a020000000258e87a21b56daf0c23be8e7070456c336f7cbaa5c8757924f545887bb2abdd750000000000ffffffff838d0427d0ec650a68aa46bb0b098aea4422c071b2ca78352a077959d07cea1d0100000000ffffffff0270aaf00800000000160014d85c2b71d0060b09c9886aeb815e50991dda124d00e1f5050000000016001400aea9a2e5f0f876a588df5546e8742d1d87008f000000000000000000"
        ).updatePreimageChallenges(0, setOf(ByteVector("01020304"), ByteVector("0102")), setOf(), setOf(ByteVector("123456")), setOf(ByteVector("abcdef"), ByteVector("00000000"))).flatMap {
            it.updatePreimageChallenges(1, setOf(ByteVector("0102")), setOf(ByteVector("123456"), ByteVector("11")), setOf(), setOf(ByteVector("abcdef"), ByteVector("00000000")))
        }.right!!
        assertEquals(setOf(ByteVector("123456")), withPreimageChallenges.inputs.first().hash160)
        assertEquals(setOf(ByteVector("123456"), ByteVector("11")), withPreimageChallenges.inputs.last().sha256)
        val decoded = Psbt.read(Psbt.write(withPreimageChallenges))
        assertTrue(decoded.isRight)
        assertEquals(decoded.right!!, withPreimageChallenges)
    }

    @Test
    fun `create psbt with various input types`() {
        val masterFingerprint = DeterministicWallet.fingerprint(masterPrivKey)
        val priv1 = DeterministicWallet.derivePrivateKey(masterPrivKey, KeyPath("m/0'/3'/1'")).privateKey
        val priv2 = DeterministicWallet.derivePrivateKey(masterPrivKey, KeyPath("m/0'/3'/2'")).privateKey
        val priv3 = DeterministicWallet.derivePrivateKey(masterPrivKey, KeyPath("m/0'/3'/3'")).privateKey
        val pubKeys = listOf(priv1, priv2, priv3).map { it.publicKey() }
        val allDerivationPaths = mapOf(
            priv1.publicKey() to KeyPathWithMaster(masterFingerprint, KeyPath("m/0'/3'/1'")),
            priv2.publicKey() to KeyPathWithMaster(masterFingerprint, KeyPath("m/0'/3'/2'")),
            priv3.publicKey() to KeyPathWithMaster(masterFingerprint, KeyPath("m/0'/3'/3'")),
        )
        val inputTx = Transaction(
            2,
            listOf(),
            listOf(
                TxOut(15000.sat(), Script.pay2pkh(priv1.publicKey())),
                TxOut(12000.sat(), Script.pay2sh(Script.createMultiSigMofN(2, pubKeys))),
                TxOut(16000.sat(), Script.pay2sh(Script.pay2wpkh(priv2.publicKey()))),
                TxOut(11000.sat(), Script.pay2wpkh(priv3.publicKey())),
                TxOut(13000.sat(), Script.pay2wsh(Script.createMultiSigMofN(2, pubKeys))),
                TxOut(10000.sat(), Script.pay2sh(Script.pay2wsh(Script.createMultiSigMofN(1, pubKeys))))
            ),
            0
        )
        val globalTx = Transaction(
            2,
            (0..5).map { i -> TxIn(OutPoint(inputTx, i.toLong()), ByteVector.empty, 0) },
            listOf(TxOut(60000.sat(), Script.pay2wsh(Script.createMultiSigMofN(1, pubKeys.drop(1))))),
            0
        )
        val psbt = Psbt(globalTx)
        assertEquals(psbt.getInput(2), Input.PartiallySignedInputWithoutUtxo(null, mapOf(), setOf(), setOf(), setOf(), setOf(), listOf()))
        assertNull(psbt.getInput(6))
        assertEquals(psbt.getInput(OutPoint(inputTx, 1)), Input.PartiallySignedInputWithoutUtxo(null, mapOf(), setOf(), setOf(), setOf(), setOf(), listOf()))
        assertNull(psbt.getInput(OutPoint(TxHash(ByteVector32.Zeroes), 0)))

        // We can't sign the psbt before adding the utxo details (updater role).
        assertTrue(psbt.sign(priv1, 0).isLeft)
        assertTrue(psbt.sign(priv3, OutPoint(inputTx, 3)).isLeft)

        // Update all inputs and outputs.
        val updated = psbt.updateNonWitnessInput(inputTx, 0, null, SIGHASH_SINGLE or SIGHASH_ANYONECANPAY, mapOf(priv1.publicKey() to KeyPathWithMaster(masterFingerprint, KeyPath("m/0'/3'/1'"))))
            .flatMap { it.updateNonWitnessInput(inputTx, 1, Script.createMultiSigMofN(2, pubKeys), SIGHASH_ALL, allDerivationPaths) }
            .flatMap { it.updateWitnessInputTx(inputTx, 2, Script.pay2wpkh(priv2.publicKey()), Script.pay2pkh(priv2.publicKey())) }
            .flatMap { it.updateWitnessInputTx(inputTx, 3, null, Script.pay2pkh(priv3.publicKey()), SIGHASH_SINGLE, mapOf(priv3.publicKey() to KeyPathWithMaster(masterFingerprint, KeyPath("m/0'/3'/3'")))) }
            .flatMap { it.updateWitnessInputTx(inputTx, 4, null, Script.createMultiSigMofN(2, pubKeys)) }
            .flatMap { it.updateWitnessInputTx(inputTx, 5, Script.pay2wsh(Script.createMultiSigMofN(1, pubKeys)), Script.createMultiSigMofN(1, pubKeys)) }
            .flatMap { it.updateWitnessOutput(0, Script.createMultiSigMofN(1, pubKeys.drop(1)), null, allDerivationPaths - priv1.publicKey()) }
            .right!!

        assertEquals((updated.getInput(0)!! as Input.NonWitnessInput.PartiallySignedNonWitnessInput).sighashType, SIGHASH_SINGLE or SIGHASH_ANYONECANPAY)
        assertEquals((updated.getInput(OutPoint(inputTx, 2))!! as Input.WitnessInput.PartiallySignedWitnessInput).redeemScript, Script.pay2wpkh(priv2.publicKey()))

        // we can add a non-segwit utxo to a segwit input, this can help detect when utxo amounts have been tampered with (see the "fee attack" test below)
        val updated1 = updated.updateNonWitnessInput(inputTx, 3, derivationPaths = allDerivationPaths).right!!
        assertEquals(updated1.inputs[3].nonWitnessUtxo!!.txOut[3], updated1.inputs[3].witnessUtxo)

        // We reject invalid updates.
        assertTrue(updated.updateWitnessInputTx(inputTx, 1, sighashType = SIGHASH_ALL).isLeft)

        val signed = updated.sign(priv1, 0)
            .flatMap { it.psbt.sign(priv1, 1) }
            .flatMap { it.psbt.sign(priv2, OutPoint(inputTx, 1)) }
            .flatMap { it.psbt.sign(priv2, 2) }
            .flatMap { it.psbt.sign(priv3, OutPoint(inputTx, 3)) }
            .flatMap { it.psbt.sign(priv2, 4) }
            .flatMap { it.psbt.sign(priv3, OutPoint(inputTx, 4)) }
            .flatMap { it.psbt.sign(priv2, 5) }
            .right!!
            .psbt

        assertEquals(signed.getInput(0)!!.partialSigs.size, 1)
        assertEquals(signed.getInput(OutPoint(inputTx, 4))!!.partialSigs.size, 2)
        assertEquals(signed.getInput(5)!!.partialSigs.size, 1)
        assertTrue(signed.finalizeWitnessInput(0, ScriptWitness(listOf(priv1.publicKey().value))).isLeft)
        assertTrue(signed.finalizeNonWitnessInput(3, listOf(OP_PUSHDATA(priv1.publicKey()))).isLeft)

        val scriptSig0 = run {
            val sig = signed.getInput(0)?.partialSigs?.get(priv1.publicKey())!!
            listOf(OP_PUSHDATA(sig), OP_PUSHDATA(priv1.publicKey()))
        }
        val scriptSig1 = run {
            val sig1 = signed.getInput(1)?.partialSigs?.get(priv1.publicKey())!!
            val sig2 = signed.getInput(1)?.partialSigs?.get(priv2.publicKey())!!
            val redeemScript = Script.write(Script.createMultiSigMofN(2, pubKeys))
            listOf(OP_0, OP_PUSHDATA(sig1), OP_PUSHDATA(sig2), OP_PUSHDATA(redeemScript))
        }
        val scriptWitness2 = run {
            val sig = signed.getInput(2)?.partialSigs?.get(priv2.publicKey())!!
            Script.witnessPay2wpkh(priv2.publicKey(), sig)
        }
        val scriptWitness3 = run {
            val sig = signed.getInput(3)?.partialSigs?.get(priv3.publicKey())!!
            Script.witnessPay2wpkh(priv3.publicKey(), sig)
        }
        val scriptWitness4 = run {
            val sig1 = signed.getInput(4)?.partialSigs?.get(priv2.publicKey())!!
            val sig2 = signed.getInput(4)?.partialSigs?.get(priv3.publicKey())!!
            Script.witnessMultiSigMofN(pubKeys, listOf(sig1, sig2))
        }
        val scriptWitness5 = run {
            val sig = signed.getInput(5)?.partialSigs?.get(priv2.publicKey())!!
            Script.witnessMultiSigMofN(pubKeys, listOf(sig))
        }

        val finalized = signed.finalizeNonWitnessInput(0, scriptSig0)
            .flatMap { it.finalizeNonWitnessInput(1, scriptSig1) }
            .flatMap { it.finalizeWitnessInput(OutPoint(inputTx, 2), scriptWitness2) }
            .flatMap { it.finalizeWitnessInput(3, scriptWitness3) }
            .flatMap { it.finalizeWitnessInput(4, scriptWitness4) }
            .flatMap { it.finalizeWitnessInput(OutPoint(inputTx, 5), scriptWitness5) }

        assertTrue(finalized.isRight)
        assertTrue(finalized.right!!.extract().isRight)
        // Once the psbt is finalized, we reject updates.
        assertTrue(finalized.right!!.sign(priv2, 2).isLeft)
        assertTrue(finalized.right!!.finalizeWitnessInput(3, scriptWitness3).isLeft)
    }

    @Test
    fun `bump lightning commit tx fee from cold wallet`() {
        fun anchorScript(fundingPubKey: PublicKey): List<ScriptElt> = listOf(
            // @formatter:off
            OP_PUSHDATA(fundingPubKey), OP_CHECKSIG, OP_IFDUP,
            OP_NOTIF,
            OP_16, OP_CHECKSEQUENCEVERIFY,
            OP_ENDIF
            // @formatter:on
        )

        // A lightning node prepares a PSBT that spends the anchor output of a commitment transaction.
        val (fundingPubKey, lightningPsbt) = run {
            val fundingPrivKey = PrivateKey(ByteVector32("0101010101010101010101010101010101010101010101010101010101010101"))
            val anchorScript = anchorScript(fundingPrivKey.publicKey())
            val txToBump = Transaction(2, listOf(), listOf(TxOut(330.toSatoshi(), Script.pay2wsh(anchorScript))), 0)
            val lightningPsbt = Psbt(Transaction(2, listOf(TxIn(OutPoint(txToBump, 0), 0)), listOf(), 0))
                .updateWitnessInputTx(txToBump, 0, null, anchorScript, SIGHASH_NONE or SIGHASH_ANYONECANPAY)
                .flatMap { it.sign(fundingPrivKey, 0) }
            assertTrue(lightningPsbt.isRight)
            Pair(fundingPrivKey.publicKey(), lightningPsbt.right!!)
        }

        // A cold wallet adds inputs and finalizes a transaction that bumps the fees of the commitment transaction.
        val walletPrivKey = PrivateKey(ByteVector32("0202020202020202020202020202020202020202020202020202020202020202"))
        val confirmedTx = Transaction(2, listOf(), listOf(TxOut(100_000.toSatoshi(), Script.pay2wpkh(walletPrivKey.publicKey()))), 0)
        val finalTx = Psbt.join(
            lightningPsbt.psbt,
            Psbt(Transaction(2, listOf(TxIn(OutPoint(confirmedTx, 0), 0)), listOf(TxOut(75_000.toSatoshi(), Script.pay2wpkh(walletPrivKey.publicKey()))), 0))
        ).flatMap {
            it.updateWitnessInputTx(confirmedTx, 0, null, Script.pay2pkh(walletPrivKey.publicKey()))
        }.flatMap {
            it.sign(walletPrivKey, 1)
        }.flatMap {
            it.psbt.finalizeWitnessInput(0, ScriptWitness(listOf(it.psbt.inputs[0].partialSigs.getValue(fundingPubKey), ByteVector(Script.write(anchorScript(fundingPubKey))))))
        }.flatMap {
            it.finalizeWitnessInput(1, Script.witnessPay2wpkh(walletPrivKey.publicKey(), it.inputs[1].partialSigs.getValue(walletPrivKey.publicKey())))
        }.flatMap {
            it.extract()
        }
        assertTrue(finalTx.isRight)
        assertNotNull(finalTx.right)
    }

    @Test
    fun `manual coinjoin workflow`() {
        val alicePrivKey = DeterministicWallet.derivePrivateKey(masterPrivKey, KeyPath("m/0'/0'/1'")).privateKey
        val aliceNextPubKey = DeterministicWallet.derivePrivateKey(masterPrivKey, KeyPath("m/0'/0'/2'")).publicKey
        val aliceInputTx = Transaction(2, listOf(), listOf(TxOut(50000.sat(), Script.pay2wpkh(alicePrivKey.publicKey()))), 0)
        val bobPrivKey = DeterministicWallet.derivePrivateKey(masterPrivKey, KeyPath("m/0'/1'/1'")).privateKey
        val bobNextPubKey = DeterministicWallet.derivePrivateKey(masterPrivKey, KeyPath("m/0'/1'/2'")).publicKey
        val bobInputTx = Transaction(2, listOf(), listOf(TxOut(40000.sat(), Script.pay2wpkh(bobPrivKey.publicKey()))), 0)
        val carolPrivKey = DeterministicWallet.derivePrivateKey(masterPrivKey, KeyPath("m/0'/2'/1'")).privateKey
        val carolNextPubKey = DeterministicWallet.derivePrivateKey(masterPrivKey, KeyPath("m/0'/2'/2'")).publicKey
        val carolInputTx = Transaction(2, listOf(), listOf(TxOut(60000.sat(), Script.pay2wpkh(carolPrivKey.publicKey()))), 0)

        // Each participant adds their inputs and fills their utxos.
        val alicePsbt = Psbt(Transaction(2, listOf(TxIn(OutPoint(aliceInputTx, 0), ByteVector.empty, 0)), listOf(TxOut(50000.sat(), Script.pay2wpkh(aliceNextPubKey))), 0))
            .updateWitnessInputTx(aliceInputTx, 0, null, Script.pay2pkh(alicePrivKey.publicKey()), SIGHASH_ALL)
            .right!!
        val bobPsbt = Psbt(Transaction(2, listOf(TxIn(OutPoint(bobInputTx, 0), ByteVector.empty, 0)), listOf(TxOut(50000.sat(), Script.pay2wpkh(bobNextPubKey))), 0))
            .updateWitnessInput(OutPoint(bobInputTx, 0), bobInputTx.txOut[0], null, Script.pay2pkh(bobPrivKey.publicKey()), SIGHASH_ALL)
            .right!!
        val carolPsbt = Psbt(Transaction(2, listOf(TxIn(OutPoint(carolInputTx, 0), ByteVector.empty, 0)), listOf(TxOut(50000.sat(), Script.pay2wpkh(carolNextPubKey))), 0))
            .updateWitnessInputTx(carolInputTx, 0, null, Script.pay2pkh(carolPrivKey.publicKey()), SIGHASH_ALL)
            .right!!

        // Carol joins the psbts, signs and finalizes her inputs.
        val carolFinal = run {
            val joined = Psbt.join(alicePsbt, bobPsbt, carolPsbt).right!!
            val outPoint = OutPoint(carolInputTx, 0)
            // Carol verifies the sighash before signing her inputs.
            assertEquals(joined.getInput(outPoint)?.sighashType, SIGHASH_ALL)
            joined.sign(carolPrivKey, outPoint).flatMap { signed ->
                signed.psbt.finalizeWitnessInput(outPoint, Script.witnessPay2wpkh(carolPrivKey.publicKey(), signed.sig))
            }.right!!
        }

        // Bob signs and finalizes his inputs.
        val bobFinal = run {
            val outPoint = OutPoint(bobInputTx, 0)
            // Bob verifies the sighash before signing his inputs.
            assertEquals(carolFinal.getInput(outPoint)?.sighashType, SIGHASH_ALL)
            carolFinal.sign(bobPrivKey, outPoint).flatMap { signed ->
                signed.psbt.finalizeWitnessInput(outPoint, Script.witnessPay2wpkh(bobPrivKey.publicKey(), signed.sig))
            }.right!!
        }

        // Alice signs and extracts the final tx.
        val conjoinTx = run {
            val outPoint = OutPoint(aliceInputTx, 0)
            // Alice verifies the sighash before signing her inputs.
            assertEquals(bobFinal.getInput(outPoint)?.sighashType, SIGHASH_ALL)
            val aliceFinal = bobFinal.sign(alicePrivKey, outPoint).flatMap { signed ->
                signed.psbt.finalizeWitnessInput(outPoint, Script.witnessPay2wpkh(alicePrivKey.publicKey(), signed.sig))
            }.right!!
            // Alice verifies that all inputs have been finalized.
            assertEquals(aliceFinal.inputs.filter {
                when (it) {
                    is Input.FinalizedInputWithoutUtxo -> true
                    is Input.WitnessInput.FinalizedWitnessInput -> true
                    is Input.NonWitnessInput.FinalizedNonWitnessInput -> true
                    else -> false
                }
            }.size, aliceFinal.inputs.size)
            aliceFinal.extract()
        }

        assertTrue(conjoinTx.isRight)
    }

    @Test
    fun `2-of-3 multisig workflow`() {
        val alicePrivKey = DeterministicWallet.derivePrivateKey(masterPrivKey, KeyPath("m/0'/0'/1'")).privateKey
        val aliceNextPubKey = DeterministicWallet.derivePrivateKey(masterPrivKey, KeyPath("m/0'/0'/2'")).publicKey
        val bobPrivKey = DeterministicWallet.derivePrivateKey(masterPrivKey, KeyPath("m/0'/1'/0'")).privateKey
        val bobNextPubKey = DeterministicWallet.derivePrivateKey(masterPrivKey, KeyPath("m/0'/1'/1'")).publicKey
        val carolPrivKey = DeterministicWallet.derivePrivateKey(masterPrivKey, KeyPath("m/0'/2'/1'")).privateKey
        val pubKeys = listOf(alicePrivKey, bobPrivKey, carolPrivKey).map { it.publicKey() }
        val inputTx = Transaction(2, listOf(), listOf(TxOut(250000.sat(), Script.pay2wsh(Script.createMultiSigMofN(2, pubKeys)))), 0)

        // Alice creates the (unsigned) PSBT and sends it to Bob and Carol.
        val spendingTx = Transaction(2, listOf(TxIn(OutPoint(inputTx, 0), ByteVector.empty, 0)), listOf(TxOut(100000.sat(), Script.pay2wpkh(aliceNextPubKey)), TxOut(125000.sat(), Script.pay2wpkh(bobNextPubKey))), 0)
        val unsignedPsbt = Psbt(spendingTx).updateWitnessInputTx(inputTx, 0, null, Script.createMultiSigMofN(2, pubKeys), SIGHASH_ALL).right!!

        // Each participant signs the input.
        val aliceSigned = unsignedPsbt.sign(alicePrivKey, 0).map { it.psbt }.right!!
        val bobSigned = unsignedPsbt.sign(bobPrivKey, 0).map { it.psbt }.right!!
        val carolSigned = unsignedPsbt.sign(carolPrivKey, 0).map { it.psbt }.right!!

        // Alice combines the inputs and broadcasts the final transaction.
        val finalTx = run {
            val combined = Psbt.combine(aliceSigned, bobSigned, carolSigned).right!!
            // Alice verifies that all participants have signed.
            val sigs = combined.inputs.first().partialSigs.filter { pubKeys.contains(it.key) }.values.toList()
            assertEquals(sigs.size, 3)
            combined.finalizeWitnessInput(0, Script.witnessMultiSigMofN(pubKeys, sigs.drop(1))).flatMap { it.extract() }
        }

        assertTrue(finalTx.isRight)
    }

    @Test
    fun `hack PSBT and overpay fees`() {
        // this test demonstrates an attack where users may overpay fee
        // 1) get users to sign a PSBT mutiple times, with utxo amounts that are much lower than the ones being spent. users will think that they're paying a small fee
        // 2) collect the signatures and build a valid transaction that spends much more in fees than what the user thinks
        // see https://blog.trezor.io/details-of-firmware-updates-for-trezor-one-version-1-9-1-and-trezor-model-t-version-2-3-1-1eba8f60f2dd for more details
        val priv1 = PrivateKey.fromHex("0101010101010101010101010101010101010101010101010101010101010101")
        val priv2 = PrivateKey.fromHex("0202020202020202020202020202020202020202020202020202020202020202")
        val utxo1 = Transaction(2, listOf(TxIn(OutPoint(TxHash("deadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeef"), 0), TxIn.SEQUENCE_FINAL)), listOf(TxOut(Satoshi(15_000_000L), Script.pay2wpkh(priv1.publicKey()))), 0)
        val utxo2 = Transaction(2, listOf(TxIn(OutPoint(TxHash("deadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeef"), 0), TxIn.SEQUENCE_FINAL)), listOf(TxOut(Satoshi(20_000_000L), Script.pay2wpkh(priv2.publicKey()))), 0)

        // create a tx that spends our utxo, with an output of 20_000_000 sats: it pays a huge fee of 15_000_000 sats
        val tx = Transaction(
            version = 2L,
            txIn = listOf(TxIn(OutPoint(utxo1, 0), 0), TxIn(OutPoint(utxo2, 0), 0)),
            txOut = listOf(TxOut(Satoshi(20_000_000L), Script.pay2pkh(priv1.publicKey()))),
            lockTime = 0
        )

        // first, lie about amount of utxo2
        val psbt1 = Psbt(tx)
            .updateWitnessInput(OutPoint(utxo1, 0), utxo1.txOut[0], null, Script.pay2pkh(priv1.publicKey()))
            .flatMap { it.updateWitnessInput(OutPoint(utxo2, 0), utxo2.txOut[0].updateAmount(Satoshi(5_000_000L + 1000)), null, Script.pay2pkh(priv2.publicKey())) }
            .right!!
        val sig1 = psbt1.sign(priv1, 0).right!!.sig

        // psbt tells us we only pay 1000 sats in fees
        assertEquals(Satoshi(1000), psbt1.computeFees())
        val spent = psbt1.inputs.sumOf { it.witnessUtxo!!.amount.toLong() }

        // then lie about amount of utxo1
        val psbt2 = Psbt(tx)
            .updateWitnessInput(OutPoint(utxo1, 0), utxo1.txOut[0].updateAmount(Satoshi(1000)), null, Script.pay2pkh(priv1.publicKey()))
            .flatMap { it.updateWitnessInput(OutPoint(utxo2, 0), utxo2.txOut[0], null, Script.pay2pkh(priv2.publicKey())) }
            .right!!
        val sig2 = psbt2.sign(priv2, 1).right!!.sig

        // we believe we pay the same fee and have spent the same amount
        assertEquals(Satoshi(1000), psbt2.computeFees())
        val spent1 = psbt2.inputs.sumOf { it.witnessUtxo!!.amount.toLong() }
        assertEquals(spent1, spent)

        // and now we use sig1 and sig2 to sign a valid tx that spends 15 000 000 sats instead of 1000 !!
        val psbt = Psbt(tx)
            .updateWitnessInput(OutPoint(utxo1, 0), utxo1.txOut[0], null, Script.pay2pkh(priv1.publicKey()))
            .flatMap { it.updateWitnessInput(OutPoint(utxo2, 0), utxo2.txOut[0], null, Script.pay2pkh(priv2.publicKey())) }
            .flatMap { it.finalizeWitnessInput(0, ScriptWitness(listOf(sig1, priv1.publicKey().value))) }
            .flatMap { it.finalizeWitnessInput(1, ScriptWitness(listOf(sig2, priv2.publicKey().value))) }
            .right!!
        assertEquals(Satoshi(15000000), psbt.computeFees())

        val signedTx = psbt.extract().right!!
        Transaction.correctlySpends(signedTx, listOf(utxo1, utxo2), ScriptFlags.STANDARD_SCRIPT_VERIFY_FLAGS)

        // this attack can be detected if the full input tx is provided in the non-witness utxo field
        val psbt3 = Psbt(tx)
            .updateWitnessInput(OutPoint(utxo1, 0), utxo1.txOut[0], null, Script.pay2pkh(priv1.publicKey()))
            .flatMap { it.updateNonWitnessInput(utxo1, 0) }
            .flatMap { it.updateWitnessInput(OutPoint(utxo2, 0), utxo2.txOut[0].updateAmount(Satoshi(5_000_000L + 1000)), null, Script.pay2pkh(priv2.publicKey())) }
            .flatMap { it.updateNonWitnessInput(utxo2, 0) }
            .right!!
        assertEquals(psbt3.inputs[1].witnessUtxo!!.publicKeyScript, psbt3.inputs[1].nonWitnessUtxo!!.txOut[0].publicKeyScript)
        // we can see that the witness utxo amount does not match the amount of the corresponding output in the non-witness utxo
        assertNotEquals(psbt3.inputs[1].witnessUtxo!!.amount, psbt3.inputs[1].nonWitnessUtxo!!.txOut[0].amount)

        // a psbt with mismatched nonWitnessUtxo and witnessUtxo should not deserialize
        assertEquals(Psbt.read(Psbt.write(psbt3)), Either.Left(ParseFailure.InvalidTxInput("witness utxo does not match non-witness utxo output")))
    }

    @Test
    fun `update keypaths`() {

        println(
            Psbt.read(
                Hex.decode(
                    "70736274ff01005e020000000127744ababf3027fe0d6cf23a96eee2efb188ef52301954585883e69b6624b2420000000000ffffffff0148e6052a010000002251200a8cbdc86de1ce1c0f9caeb22d6df7ced3683fe423e05d1e402a879341d6f6f5000000000001012b00f2052a010000002251205a2c2cf5b52cf31f83ad2e8da63ff03183ecd8f609c7510ae8a48e03910a07572116fe349064c98d6e2a853fa3c9b12bd8b304a19c195c60efa7ee2393046d3fa2321900772b2da75600008001000080000000800100000000000000011720fe349064c98d6e2a853fa3c9b12bd8b304a19c195c60efa7ee2393046d3fa2320001052050929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac001066f02c02220736e572900fe1252589a2143c8f3c79f71a0412d2353af755e9701c782694a02ac02c02220631c5f3b5832b8fbdebfb19704ceeb323c21f40f7a24f43d68ef0cc26b125969ac01c0222044faa49a0338de488c8dfffecdfb6f329f380bd566ef20c8df6d813eab1c4273ac210744faa49a0338de488c8dfffecdfb6f329f380bd566ef20c8df6d813eab1c42733901f06b798b92a10ed9a9d0bbfd3af173a53b1617da3a4159ca008216cd856b2e0e772b2da75600008001000080010000800000000003000000210750929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac005007c461e5d2107631c5f3b5832b8fbdebfb19704ceeb323c21f40f7a24f43d68ef0cc26b125969390118ace409889785e0ea70ceebb8e1ca892a7a78eaede0f2e296cf435961a8f4ca772b2da756000080010000800200008000000000030000002107736e572900fe1252589a2143c8f3c79f71a0412d2353af755e9701c782694a02390129a5b4915090162d759afd3fe0f93fa3326056d0b4088cb933cae7826cb8d82c772b2da7560000800100008003000080000000000300000000"
                )
            )
        )

        val priv1 = PrivateKey.fromHex("0101010101010101010101010101010101010101010101010101010101010101")
        val priv2 = PrivateKey.fromHex("0202020202020202020202020202020202020202020202020202020202020202")
        val utxo1 = Transaction(2, listOf(), listOf(TxOut(Satoshi(15_000_000L), Script.pay2wpkh(priv1.publicKey()))), 0)
        val utxo2 = Transaction(2, listOf(), listOf(TxOut(Satoshi(20_000_000L), Script.pay2pkh(priv2.publicKey()))), 0)
        val tx = Transaction(
            version = 2L,
            txIn = listOf(TxIn(OutPoint(utxo1, 0), 0), TxIn(OutPoint(utxo2, 0), 0)),
            txOut = listOf(TxOut(Satoshi(10_000_000L), Script.pay2wpkh(priv1.publicKey())), TxOut(Satoshi(10_000_000L), Script.pay2pkh(priv2.publicKey()))),
            lockTime = 0
        )

        val psbt = Psbt(tx)
            .updateWitnessInput(OutPoint(utxo1, 0), utxo1.txOut[0], null, Script.pay2pkh(priv1.publicKey()), derivationPaths = mapOf(priv1.publicKey() to KeyPathWithMaster(0, KeyPath("m/0'"))))
            .flatMap { it.updateNonWitnessInput(utxo2, 0, redeemScript = Script.pay2pkh(priv2.publicKey()), derivationPaths = mapOf(priv2.publicKey() to KeyPathWithMaster(0, KeyPath("m/1'")))) }
            .flatMap { it.updateWitnessOutput(0, derivationPaths = mapOf(priv1.publicKey() to KeyPathWithMaster(0, KeyPath("m/2'")))) }
            .flatMap { it.updateWitnessOutput(1, derivationPaths = mapOf(priv2.publicKey() to KeyPathWithMaster(0, KeyPath("m/3'")))) }
            .right!!

        val updated = psbt
            .updateWitnessInput(OutPoint(utxo1, 0), utxo1.txOut[0], null, Script.pay2pkh(priv1.publicKey()), derivationPaths = mapOf(priv1.publicKey() to KeyPathWithMaster(0, KeyPath("m/4'"))))
            .flatMap { it.updateNonWitnessInput(utxo2, 0, redeemScript = Script.pay2pkh(priv2.publicKey()), derivationPaths = mapOf(priv2.publicKey() to KeyPathWithMaster(0, KeyPath("m/5'")))) }
            .flatMap { it.updateWitnessOutput(0, derivationPaths = mapOf(priv1.publicKey() to KeyPathWithMaster(0, KeyPath("m/6'")))) }
            .flatMap { it.updateWitnessOutput(1, derivationPaths = mapOf(priv2.publicKey() to KeyPathWithMaster(0, KeyPath("m/7'")))) }
            .right!!

        assertEquals(updated.inputs[0].derivationPaths, mapOf(priv1.publicKey() to KeyPathWithMaster(0, KeyPath("m/4'"))))
        assertEquals(updated.inputs[1].derivationPaths, mapOf(priv2.publicKey() to KeyPathWithMaster(0, KeyPath("m/5'"))))
        assertEquals(updated.outputs[0].derivationPaths, mapOf(priv1.publicKey() to KeyPathWithMaster(0, KeyPath("m/6'"))))
        assertEquals(updated.outputs[1].derivationPaths, mapOf(priv2.publicKey() to KeyPathWithMaster(0, KeyPath("m/7'"))))
    }

    private fun readValidPsbt(hex: String): Psbt {
        val result = Psbt.read(ByteVector(hex))
        assertTrue(result.isRight)
        return result.right!!
    }

    private fun verifyNoUnknown(psbt: Psbt) {
        assertTrue(psbt.global.unknown.isEmpty())
        psbt.inputs.forEach { assertTrue(it.unknown.isEmpty()) }
        psbt.outputs.forEach { assertTrue(it.unknown.isEmpty()) }
    }

    private fun verifyEmptyOutput(output: Output) {
        assertNull(output.redeemScript)
        assertNull(output.witnessScript)
        assertTrue(output.derivationPaths.isEmpty())
        assertTrue(output.unknown.isEmpty())
    }

}